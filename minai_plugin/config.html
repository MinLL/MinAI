<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration Page</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --background-dark: #1a1a1a;
            --background-light: #2d2d2d;
            --text-color: #e0e0e0;
            --border-color: #404040;
            --success-color: #40c057;
            --error-color: #f44336;
            --warning-color: #ffc107;
            --info-color: #4dabf7;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--background-dark);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            background: radial-gradient(circle at center, var(--background-light) 0%, var(--background-dark) 100%);
            min-height: 100vh;
        }

        .config-container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 30px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .config-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Ensure full-width sections stay full width */
        .config-section.full-width {
            grid-column: 1 / -1;
        }

        .nav-panel {
            background-color: var(--background-light);
            padding: 15px;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(4px);
        }

        .nav-panel a {
            display: inline-block;
            color: var(--text-color);
            text-decoration: none;
            font-size: 1.1rem;
            margin: 0 20px;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.05) 100%
            );
            border: 1px solid var(--border-color);
        }

        .nav-panel a:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.15) 0%,
                rgba(255, 255, 255, 0.08) 100%
            );
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        h1 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .option-group {
            margin-bottom: 25px;
            padding: 20px;
            background-color: rgba(45, 45, 45, 0.4);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(4px);
        }

        .option-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .option-group p {
            color: var(--text-color);
            opacity: 0.8;
            margin: 10px 0;
            font-size: 0.95rem;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            background-color: var(--background-dark);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
            accent-color: var(--primary-color);
        }

        .submit-button {
            display: inline-block;
            color: var(--text-color);
            text-decoration: none;
            font-size: 1.1rem;
            margin: 0 20px;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg,
                rgba(76, 175, 80, 0.1) 0%,
                rgba(76, 175, 80, 0.2) 100%
            );
            border: 1px solid rgba(76, 175, 80, 0.3);
            cursor: pointer;
        }

        .submit-button.has-changes {
            background: linear-gradient(135deg,
                rgba(255, 193, 7, 0.2) 0%,
                rgba(255, 193, 7, 0.3) 100%
            );
            border: 1px solid var(--warning-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
            }
        }

        .nav-link {
            color: var(--text-color);
            text-decoration: none;
            font-size: 1.1rem;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .section-header {
            background: linear-gradient(135deg,
                rgba(33, 150, 243, 0.1) 0%,
                rgba(33, 150, 243, 0.2) 100%
            );
            color: var(--text-color);
            padding: 15px 20px;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.3s ease;
            border: 1px solid rgba(33, 150, 243, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .section-header::after {
            content: '▼';
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .section-header.collapsed::after {
            transform: rotate(-90deg);
        }

        .section-header:hover {
            background: linear-gradient(135deg,
                rgba(33, 150, 243, 0.15) 0%,
                rgba(33, 150, 243, 0.25) 100%
            );
            transform: translateY(-1px);
        }

        .section-content {
            padding: 20px;
            background-color: rgba(45, 45, 45, 0.4);
            border-radius: 8px;
            margin-top: 5px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(4px);
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin 0.3s ease-out;
            max-height: none;
            opacity: 1;
            overflow: hidden;
        }

        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            padding-top: 0;
            padding-bottom: 0;
            border: none;
        }

        .info-section {
            padding: 15px;
            background: linear-gradient(135deg,
                rgba(255, 193, 7, 0.1) 0%,
                rgba(255, 193, 7, 0.15) 100%
            );
            color: var(--text-color);
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .preview-panel {
            background-color: var(--background-light);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .preview-item {
            margin: 10px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .preview-label {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-label:after {
            content: '▼';
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        
        .preview-label.collapsed:after {
            transform: rotate(-90deg);
        }
        
        .preview-content-wrapper {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }
        
        .preview-content-wrapper.collapsed {
            max-height: 0;
        }
        
        .preview-content {
            color: var(--text-color);
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-word;
            max-width: 100%;
            overflow-wrap: break-word;
        }
        
        .refresh-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        
        .refresh-button:hover {
            background: var(--secondary-color);
        }

        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }

            .config-container {
                margin: 20px;
                padding: 20px;
            }

            .nav-panel a {
                display: block;
                margin: 10px 0;
            }

            h1 {
                font-size: 2rem;
            }

            .preview-panel {
                padding: 10px;
            }
            
            .section-preview {
                padding: 10px;
            }
            
            .preview-content {
                font-size: 14px;
            }
        }

        .variable-entry {
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .variable-entry code {
            color: var(--primary-color);
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 5px;
            border-radius: 3px;
        }

        .section-preview {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .section-preview h3 {
            color: var(--primary-color);
            margin: 0 0 10px 0;
        }

        .error {
            color: var(--error-color);
            background: rgba(244, 67, 54, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--error-color);
            margin: 10px 0;
        }

        pre {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            color: var(--text-color);
        }

        #preview .section-header {
            margin-bottom: 0;
        }
        
        #preview .section-content {
            margin-top: 10px;
        }
        
        #preview .option-description {
            margin-top: 0;
        }

        /* Improve spacing in two-column layout */
        .config-column .config-section:first-child {
            margin-top: 0;
        }

        .config-column .config-section:last-child {
            margin-bottom: 0;
        }

        /* Ensure consistent heights for option groups */
        .option-group {
            height: fit-content;
        }

        /* Improve spacing for the submit button */
        .submit-button {
            margin: 30px auto;
            max-width: 800px;
        }

        .control-buttons {
            text-align: center;
            margin: 20px 0;
        }

        .control-button {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg,
                rgba(76, 175, 80, 0.2) 0%,
                rgba(76, 175, 80, 0.3) 100%
            );
            color: var(--text-color);
            border: 1px solid rgba(76, 175, 80, 0.4);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
            margin: 0 10px;
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg,
                rgba(76, 175, 80, 0.25) 0%,
                rgba(76, 175, 80, 0.35) 100%
            );
        }

        .voicetype-entry {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .voicetype-entry input {
            flex: 1;
            padding: 8px;
            background-color: var(--background-dark);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 8px;
        }

        .voicetype-entry button {
            padding: 8px 16px;
            background: linear-gradient(135deg,
                rgba(244, 67, 54, 0.2) 0%,
                rgba(244, 67, 54, 0.3) 100%
            );
            color: var(--text-color);
            border: 1px solid rgba(244, 67, 54, 0.4);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .voicetype-entry button:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg,
                rgba(244, 67, 54, 0.25) 0%,
                rgba(244, 67, 54, 0.35) 100%
            );
        }

        .section-fields {
            margin-top: 10px;
        }

        .field-group {
            margin-bottom: 15px;
        }

        .field-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-color);
            font-weight: 500;
        }

        .section-header-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .section-header-row h4 {
            margin: 0;
            color: var(--primary-color);
        }

        .drag-handle {
            cursor: move;
            color: var(--border-color);
            user-select: none;
        }

        .section-entry {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .prompt-group {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .prompt-group h4 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            font-size: 1.1em;
        }

        .info-section details {
            margin: 10px 0;
        }

        .info-section details ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .info-section details pre {
            margin: 5px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .example-block {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .important-note {
            background: rgba(76, 175, 80, 0.1);
            border-left: 3px solid var(--primary-color);
            padding: 10px 15px;
            margin: 15px 0;
        }

        .example-block ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .example-block em {
            color: var(--secondary-color);
        }

        .template-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .template-button {
            padding: 8px 16px;
            background: linear-gradient(135deg,
                rgba(33, 150, 243, 0.1) 0%,
                rgba(33, 150, 243, 0.2) 100%
            );
            color: var(--text-color);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .template-button:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg,
                rgba(33, 150, 243, 0.15) 0%,
                rgba(33, 150, 243, 0.25) 100%
            );
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .submit-button:disabled {
            opacity: 0.7;
            cursor: wait;
            transform: none !important;
        }

        .submit-button.loading {
            position: relative;
            padding-left: 45px;
        }

        .submit-button.loading:before {
            content: '';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--text-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: translateY(-50%) rotate(360deg);
            }
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }

        .overlay.active {
            display: flex;
        }

        .save-message {
            background: var(--background-light);
            padding: 20px 40px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 1.1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .nav-button {
            display: inline-block;
            color: var(--text-color);
            text-decoration: none;
            font-size: 1.1rem;
            margin: 0 20px;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg,
                rgba(76, 175, 80, 0.1) 0%,
                rgba(76, 175, 80, 0.2) 100%
            );
            border: 1px solid rgba(76, 175, 80, 0.3);
            cursor: pointer;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg,
                rgba(76, 175, 80, 0.15) 0%,
                rgba(76, 175, 80, 0.25) 100%
            );
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .status-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: var(--text-color);
            font-size: 1rem;
            z-index: 1000;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        .status-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .status-message.success {
            background: linear-gradient(135deg,
                rgba(76, 175, 80, 0.9) 0%,
                rgba(76, 175, 80, 0.8) 100%
            );
            border: 1px solid var(--success-color);
        }

        .status-message.error {
            background: linear-gradient(135deg,
                rgba(244, 67, 54, 0.9) 0%,
                rgba(244, 67, 54, 0.8) 100%
            );
            border: 1px solid var(--error-color);
        }

        .status-message.info {
            background: linear-gradient(135deg,
                rgba(33, 150, 243, 0.9) 0%,
                rgba(33, 150, 243, 0.8) 100%
            );
            border: 1px solid var(--info-color);
        }

        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--background-dark);
            padding: 10px 20px;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .top-bar h1 {
            margin: 0;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .nav-panel {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            padding: 0;
            background: none;
            border: none;
            box-shadow: none;
            flex-wrap: wrap;
        }

        .nav-divider {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 0 10px;
        }

        .config-container {
            margin-top: 80px; 
        }

        .changes-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1100;
            backdrop-filter: blur(4px);
        }

        .changes-modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--background-dark);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .modal-content h2 {
            margin: 0 0 20px 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }

        .changes-list {
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 20px;
            flex-grow: 1;
        }

        .change-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .change-item .setting-name {
            color: var(--primary-color);
            font-weight: 500;
            margin-bottom: 5px;
        }

        .change-item .change-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .change-item .old-value,
        .change-item .new-value {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            word-break: break-word;
        }

        .change-item .old-value {
            border-left: 3px solid var(--error-color);
        }

        .change-item .new-value {
            border-left: 3px solid var(--success-color);
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .modal-button {
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .modal-button.cancel {
            background: linear-gradient(135deg,
                rgba(244, 67, 54, 0.1) 0%,
                rgba(244, 67, 54, 0.2) 100%
            );
            border: 1px solid var(--error-color);
            color: var(--text-color);
        }

        .modal-button.confirm {
            background: linear-gradient(135deg,
                rgba(76, 175, 80, 0.1) 0%,
                rgba(76, 175, 80, 0.2) 100%
            );
            border: 1px solid var(--success-color);
            color: var(--text-color);
        }

        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .no-changes {
            text-align: center;
            padding: 20px;
            color: var(--text-color);
            font-style: italic;
        }

        .help-text {
            font-size: 0.9em;
            color: #888;
            margin-top: 4px;
            margin-bottom: 8px;
            font-style: italic;
        }

        .reset-button {
            background: transparent;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            padding: 4px 8px;
            font-size: 0.9em;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .reset-button:hover {
            background: rgba(33, 150, 243, 0.1);
        }

        .nav-button.warning {
            background: linear-gradient(135deg,
                rgba(244, 67, 54, 0.1) 0%,
                rgba(244, 67, 54, 0.2) 100%
            );
            border: 1px solid var(--error-color);
        }

        .nav-button.warning:hover {
            background: linear-gradient(135deg,
                rgba(244, 67, 54, 0.15) 0%,
                rgba(244, 67, 54, 0.25) 100%
            );
        }

        .option-label-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        /* Add these styles */
        .option-label-container.modified {
            position: relative;
        }

        .option-label-container.modified::after {
            content: '•';
            color: var(--warning-color);
            font-size: 1.5em;
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            animation: pulse 2s infinite;
        }

        .section-header-row.modified::after {
            content: '•';
            color: var(--warning-color);
            font-size: 1.5em;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .preview-item h3 {
            margin: 10px 0 5px 0;
            color: var(--primary-color);
            font-size: 1.3em;
            border-bottom: 1px solid rgba(33, 150, 243, 0.3);
            padding-bottom: 5px;
        }
        
        .system-prompt-preview {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .system-prompt-preview .preview-content {
            max-height: 600px;
            overflow-y: auto;
            padding: 15px;
            background-color: rgba(30, 30, 30, 0.7);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .preview-description {
            color: var(--text-color);
            font-style: italic;
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(76, 175, 80, 0.1);
            border-radius: 5px;
            border-left: 4px solid var(--primary-color);
        }

        .actor-name-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .actor-name-input label {
            font-weight: bold;
            min-width: 150px;
        }
        
        .actor-name-input input {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--background-light);
            color: var(--text-color);
            font-size: 14px;
            width: 250px;
        }
        
        .actor-name-input input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.3);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
</head>
<body>

    <div class="top-bar">
        <h1>Configuration Page</h1>
        <div class="nav-panel">
            <a href="index.html" class="nav-link">Home</a>
            <a href="https://github.com/MinLL/MinAI" class="nav-link">Docs</a>
            <button onclick="exportConfig()" class="nav-button">Export</button>
            <button onclick="document.getElementById('import-input').click()" class="nav-button">Import</button>
            <input type="file" id="import-input" style="display: none" accept=".json" onchange="importConfig(event)">
            <button onclick="resetAllToDefaults()" class="nav-button warning">Reset All to Defaults</button>
            <div class="nav-divider"></div>
            <button onclick="toggleAllSections(true)" class="nav-button">Expand All</button>
            <button onclick="toggleAllSections(false)" class="nav-button">Collapse All</button>
            <div class="nav-divider"></div>
            <button onclick="submitConfiguration()" class="submit-button" id="save-button">Save Configuration</button>
        </div>
    </div>

    <div class="config-container">
        <!-- Information Section -->
        <div class="info-section" id="info-section" style="display: none;">
            <div id="error-display" style="display: none;">
                <h3 style="color: var(--error-color);">Configuration Error</h3>
                <pre id="error-details" class="error"></pre>
            </div>
        </div>
        <p id="loading-message">Loading configuration...</p>

        <div id="config-form" style="display: none;">
            <div class="config-grid">
                <div class="config-column">
                    <!-- LLM Settings Section -->
                    <div class="config-section">
                        <div class="section-header collapsed" onclick="toggleSection(this)">
                            LLM Settings
                        </div>
                        <div class="section-content collapsed">
                            <!-- enforce_short_responses -->
                            <div class="option-group checkbox-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="enforce-short-responses">Enforce Short Responses</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('enforce-short-responses')">Reset to Default</button>
                                </div>
                                <p>Attempt to enforce short 2-3 sentence responses from the LLM. This is "best effort", and does not always work.</p>
                                <input type="checkbox" id="enforce-short-responses">
                            </div>

                            <!-- use_llm_fallback -->
                            <div class="option-group checkbox-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="use-llm-fallback">Use LLM Fallback</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('use-llm-fallback')">Reset to Default</button>
                                </div>
                                <p>Enable fallback to alternative LLM configuration when primary LLM call fails. 
                                    This can help recover from errors and censorship, but will result in increased token cost and response time 
                                    when a retry is performed. Response time hit is fairly minimal, but the full token cost of both requests 
                                    will be charged. The connector settings for the "LLMFallback" profile will be used (This will be created if it doesn't exist when you boot the game),
                                    and it will only work with openrouterjson.</p>
                                <input type="checkbox" id="use-llm-fallback">
                            </div>

                            <!-- strip_emotes_from_output -->
                            <div class="option-group checkbox-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="strip-emotes">Strip emotes from output</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('strip-emotes')">Reset to Default</button>
                                </div>
                                <p>Remove anything between two astericks from the response...</p>
                                <input type="checkbox" id="strip-emotes">
                            </div>

                            <!-- enforce_single_json -->
                            <div class="option-group checkbox-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="enforce-single-json">Enforce Single JSON Response</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('enforce-single-json')">Reset to Default</button>
                                </div>
                                <p>Forces the LLM to provide only one single JSON response object per interaction...</p>
                                <input type="checkbox" id="enforce-single-json">
                            </div>
                        </div>
                    </div>

                    <!-- Gameplay Features Section -->
                    <div class="config-section">
                        <div class="section-header collapsed" onclick="toggleSection(this)">
                            Gameplay Features
                        </div>
                        <div class="section-content collapsed">
                            <!-- disable_nsfw -->
                            <div class="option-group checkbox-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="disable-nsfw">Disable NSFW</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('disable-nsfw')">Reset to Default</button>
                                </div>
                                <p>Globally disable all NSFW features.</p>
                                <input type="checkbox" id="disable-nsfw">
                            </div>

                            <!-- restrict_nonfollower_functions -->
                            <div class="option-group checkbox-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="restrict-nonfollower-functions">Restrict Non-Follower Functions</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('restrict-nonfollower-functions')">Reset to Default</button>
                                </div>
                                <p>Restrict actions that only make sense for followers to followers.</p>
                                <input type="checkbox" id="restrict-nonfollower-functions">
                            </div>

                            <!-- always_enable_functions -->
                            <div class="option-group checkbox-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="always-enable-functions">Always Enable Functions</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('always-enable-functions')">Reset to Default</button>
                                </div>
                                <p>Enable functions during things like rechat. Disabled for the narrator to avoid crashes (CTD).</p>
                                <input type="checkbox" id="always-enable-functions">
                            </div>

                            <!-- force_aiff_name_to_ingame_name -->
                            <div class="option-group checkbox-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="force-aiff-name">Force CHIM Name to Match In-Game Name</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('force-aiff-name')">Reset to Default</button>
                                </div>
                                <p>Force the configured name in CHIM to match the in-game name.</p>
                                <input type="checkbox" id="force-aiff-name">
                            </div>

                            <!-- disable_worn_equipment -->
                            <div class="option-group checkbox-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="disable-worn-equipment">Disable Worn Equipment</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('disable-worn-equipment')">Reset to Default</button>
                                </div>
                                <p>Disable the worn equipment system, which customizes the description of items that actors are wearing.</p>
                                <input type="checkbox" id="disable-worn-equipment">
                            </div>

                            <!-- use_defeat -->
                            <div class="option-group checkbox-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="use-defeat">Add Support for Defeat mods</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('use-defeat')">Reset to Default</button>
                                </div>
                                <p>If using a supported defeat mod, the LLM will differentiate between victory and defeat in combat.</p>
                                <input type="checkbox" id="use-defeat">
                            </div>

                            <!-- realnames_support -->
                            <div class="option-group checkbox-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="realnames-support">Add Support for Realnames Extended</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('realnames-support')">Reset to Default</button>
                                </div>
                                <p>Automatically seed NPC profiles that are renamed via Realnames Extended...</p>
                                <input type="checkbox" id="realnames-support">
                            </div>
                            
                            <!-- Inventory Settings Header -->
                            <div class="option-group">
                                <h4>Inventory Settings</h4>
                                
                                <!-- inventory_items_limit -->
                                <div class="option-group">
                                    <div class="option-label-container">
                                        <label class="option-label" for="inventory-items-limit">Inventory Items Limit</label>
                                        <button class="reset-button" onclick="resetOptionToDefault('inventory-items-limit')">Reset to Default</button>
                                    </div>
                                    <p>Number of items to expose to the LLM from an actor's inventory. Higher values give the LLM more options but use more context.</p>
                                    <input type="number" id="inventory-items-limit" min="1" max="20">
                                </div>
                                
                                <!-- use_item_relevancy_scoring -->
                                <div class="option-group checkbox-group">
                                    <div class="option-label-container">
                                        <label class="option-label" for="use-item-relevancy-scoring">Use Item Relevancy Scoring</label>
                                        <button class="reset-button" onclick="resetOptionToDefault('use-item-relevancy-scoring')">Reset to Default</button>
                                    </div>
                                    <p>Use relevancy scoring for inventory items (Future implementation - Currently unavailable)</p>
                                    <input type="checkbox" id="use-item-relevancy-scoring">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Event Settings Section -->
                    <div class="config-section">
                        <div class="section-header collapsed" onclick="toggleSection(this)">
                            Event Settings
                        </div>
                        <div class="section-content collapsed">
                            <!-- commands_to_purge -->
                            <div class="option-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="commands-to-purge">Commands to Purge</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('commands-to-purge')">Reset to Default</button>
                                </div>
                                <p>List of commands to disable.</p>
                                <div id="commands-to-purge-container" class="dynamic-list-container"></div>
                                <button class="add-list-item" onclick="addListItem('commands-to-purge-container')">Add Command to Purge</button>
                            </div>

                            <!-- events_to_ignore -->
                            <div class="option-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="events-to-ignore">Events to Ignore</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('events-to-ignore')">Reset to Default</button>
                                </div>
                                <p>List of game events to ignore...</p>
                                <div id="events-to-ignore-container" class="dynamic-list-container"></div>
                                <button class="add-list-item" onclick="addListItem('events-to-ignore-container')">Add Event to Ignore</button>
                            </div>

                            <!-- input_delay_for_radiance -->
                            <div class="option-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="input-delay">Input Delay for Radiance (Seconds)</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('input-delay')">Reset to Default</button>
                                </div>
                                <p>Prevents radiant dialogue from triggering too quickly after player input...</p>
                                <input type="range" id="input-delay" min="0" max="30" value="15">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="config-column">
                    <!-- Narrator Settings Section -->
                    <div class="config-section">
                        <div class="section-header collapsed" onclick="toggleSection(this)">
                            Narrator Settings
                        </div>
                        <div class="section-content collapsed">
                            <!-- PROMPT_HEAD_OVERRIDE -->
                            <div class="option-group text-input">
                                <div class="option-label-container">
                                    <label class="option-label" for="prompt-head-override">PROMPT_HEAD_OVERRIDE</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('prompt-head-override')">Reset to Default</button>
                                </div>
                                <p>Set this to override the prompt head for all profiles...</p>
                                <input type="text" id="prompt-head-override">
                            </div>

                            <!-- use_narrator_profile -->
                            <div class="option-group checkbox-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="use-narrator-profile">Use Narrator Profile</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('use-narrator-profile')">Reset to Default</button>
                                </div>
                                <p>Use an alternative profile for the narrator instead of the default one...</p>
                                <input type="checkbox" id="use-narrator-profile">
                            </div>

                            <!-- stop_narrator_context_leak -->
                            <div class="option-group checkbox-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="stop-narrator-context-leak">Stop Narrator Context Leak</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('stop-narrator-context-leak')">Reset to Default</button>
                                </div>
                                <p>Purge narrator dialogue from the context that is shared with nearby NPC's...</p>
                                <input type="checkbox" id="stop-narrator-context-leak">
                            </div>

                            <!-- devious_narrator_eldritch_voice -->
                            <div class="option-group text-input">
                                <div class="option-label-container">
                                    <label class="option-label" for="eldritch-voice">Eldritch Voice Type</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('eldritch-voice')">Reset to Default</button>
                                </div>
                                <p>Voice type to use for eldritch narration...</p>
                                <input type="text" id="eldritch-voice">
                            </div>

                            <!-- devious_narrator_telvanni_voice -->
                            <div class="option-group text-input">
                                <div class="option-label-container">
                                    <label class="option-label" for="telvanni-voice">Devious Narrator Telvanni Voice</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('telvanni-voice')">Reset to Default</button>
                                </div>
                                <p>If the Telvanni Devious Narrator is active, override it's voice type with the specified id.</p>
                                <input type="text" id="telvanni-voice">
                            </div>

                            <!-- self_narrator_toggle -->
                            <div class="option-group checkbox-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="self-narrator">Use Self Narrator</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('self-narrator')">Reset to Default</button>
                                </div>
                                <p>Add support for the Narrator roleplaying as the character thinking to themself...</p>
                                <input type="checkbox" id="self-narrator">
                            </div>
                        </div>
                    </div>

                    <!-- Voice Settings Section -->
                    <div class="config-section">
                        <div class="section-header collapsed" onclick="toggleSection(this)">
                            Voice Settings
                        </div>
                        <div class="section-content collapsed">
                            <!-- force_voice_type -->
                            <div class="option-group checkbox-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="force-voice-type">Force Voice Type</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('force-voice-type')">Reset to Default</button>
                                </div>
                                <p>Force the voice type to use the actor's base voice type...</p>
                                <input type="checkbox" id="force-voice-type">
                            </div>

                            <!-- VoiceType Fallbacks -->
                            <div class="option-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="voicetype-fallbacks">VoiceType Fallbacks</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('voicetype-fallbacks')">Reset to Default</button>
                                </div>
                                <p>Provide default voices for specific gender and race combinations...</p>
                                <div id="voicetype-container" class="voicetype-container"></div>
                                <button class="add-voicetype" onclick="addVoiceTypeEntry()">Add VoiceType Fallback</button>
                            </div>
                        </div>
                    </div>

                    <!-- Action Prompts Section -->
                    <div class="config-section">
                        <div class="section-header collapsed" onclick="toggleSection(this)">
                            Action Prompts
                        </div>
                        <div class="section-content collapsed">
                            <div class="info-section">
                                <p>Customize the prompts used to instruct the LLM on how to use actions in different situations. Available variables:</p>
                                <ul>
                                    <li>#target# - The name of the target actor</li>
                                    <li>#player_name# - The player's name</li>
                                    <li>#herika_name# - The name of the NPC that's going to respond to the prompt</li>
                                </ul>
                                <details>
                                    <summary>Pronoun Variables</summary>
                                    <ul>
                                        <li><strong>Target pronouns:</strong> #target_subject# (he/she/they), #target_object# (him/her/them), #target_possessive# (his/her/their)</li>
                                        <li><strong>Player pronouns:</strong> #player_subject#, #player_object#, #player_possessive#</li>
                                        <li><strong>Herika pronouns:</strong> #herika_subject#, #herika_object#, #herika_possessive#</li>
                                    </ul>
                                </details>
                            </div>
                            
                            <!-- Singing Prompt -->
                            <div class="option-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="singing-prompt">Singing Prompt</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('singing-prompt')">Reset to Default</button>
                                </div>
                                <textarea id="singing-prompt" class="prompt-textarea" rows="3"></textarea>
                            </div>

                            <!-- Add new Diary Prompts section -->
                            <div class="option-group">
                                <h4>Diary Prompts</h4>
                                
                                <!-- For player-diary -->
                                <div class="option-group">
                                    <div class="option-label-container">
                                        <label class="option-label" for="player-diary">Player's Diary Entry Prompt</label>
                                        <button class="reset-button" onclick="resetOptionToDefault('player-diary')">Reset to Default</button>
                                    </div>
                                    <p>Customize how the player character writes their diary entries (If using the Self Narrator feature).</p>
                                    <textarea id="player-diary" class="prompt-textarea" rows="4"></textarea>
                                </div>

                                <!-- For follower-diary -->
                                <div class="option-group">
                                    <div class="option-label-container">
                                        <label class="option-label" for="follower-diary">Follower's Diary Entry Prompt</label>
                                        <button class="reset-button" onclick="resetOptionToDefault('follower-diary')">Reset to Default</button>
                                    </div>
                                    <p>Customize how followers write their diary entries about traveling with the player.</p>
                                    <textarea id="follower-diary" class="prompt-textarea" rows="4"></textarea>
                                </div>
                            </div>

                            <!-- For self-narrator-explicit -->
                            <div class="option-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="self-narrator-explicit">Self Narrator (Explicit Scene)</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('self-narrator-explicit')">Reset to Default</button>
                                </div>
                                <textarea id="self-narrator-explicit" class="prompt-textarea" rows="4"></textarea>
                            </div>

                            <!-- For self-narrator-normal -->
                            <div class="option-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="self-narrator-normal">Self Narrator (Normal Scene)</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('self-narrator-normal')">Reset to Default</button>
                                </div>
                                <textarea id="self-narrator-normal" class="prompt-textarea" rows="4"></textarea>
                            </div>

                            <!-- For explicit-scene -->
                            <div class="option-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="explicit-scene">Explicit Scene</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('explicit-scene')">Reset to Default</button>
                                </div>
                                <textarea id="explicit-scene" class="prompt-textarea" rows="4"></textarea>
                            </div>

                            <!-- For normal-scene -->
                            <div class="option-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="normal-scene">Normal Scene</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('normal-scene')">Reset to Default</button>
                                </div>
                                <textarea id="normal-scene" class="prompt-textarea" rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Full width sections -->
            <div class="config-grid">
                <div class="config-section full-width">
                    <!-- Roleplay Translation Settings Section -->
                    <div class="config-section">
                        <div class="section-header collapsed" onclick="toggleSection(this)">
                            Roleplay Translation Settings
                        </div>
                        <div class="section-content collapsed">
                            <div class="info-section">
                                <p><strong>💡 Translation vs Roleplay: Understanding the Two Modes</strong></p>
                                
                                <details>
                                    <summary><strong>Translation Mode (Converting Player Input)</strong></summary>
                                    <p>Used when the player types dialogue that needs to be converted into their character's speaking style.</p>
                                    <div class="example-block">
                                        <p><strong>Example Scenario:</strong></p>
                                        <ul>
                                            <li>Player types: "Let's explore that cave"</li>
                                            <li>Translation prompt: "Translate this casual speech into your character's manner: '#ORIGINAL_INPUT#'"</li>
                                            <li>Character responds: "These ancient Nordic ruins beckon to be explored, shall we venture forth?"</li>
                                        </ul>
                                        <p><em>Translation mode preserves the player's intended meaning while adapting the speaking style.</em></p>
                                    </div>
                                </details>

                                <details>
                                    <summary><strong>Roleplay Mode (Automatic Responses)</strong></summary>
                                    <p>Used with the "tap to roleplay" feature where the character generates appropriate dialogue for the situation.</p>
                                    <div class="example-block">
                                        <p><strong>Example Scenario:</strong></p>
                                        <ul>
                                            <li>Situation: Standing near a cave entrance</li>
                                            <li>Roleplay prompt: "Respond naturally as your character would in this situation"</li>
                                            <li>Character initiates: "The air from these ruins carries the weight of ancient secrets. We should proceed with caution."</li>
                                        </ul>
                                        <p><em>Roleplay mode creates new dialogue based on context and character personality.</em></p>
                                    </div>
                                </details>

                                <div class="important-note">
                                    <p><strong>Key Technical Differences:</strong></p>
                                    <ul>
                                        <li>Translation prompts must include '#ORIGINAL_INPUT#' variable</li>
                                        <li>Roleplay prompts focus on generating contextual responses</li>
                                        <li>Both modes should maintain character personality and current situation awareness</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Context Messages -->
                            <div class="option-group">
                                <div class="option-label-container">
                                    <label class="option-label" for="context-messages">Context Messages</label>
                                    <button class="reset-button" onclick="resetOptionToDefault('context-messages')">Reset to Default</button>
                                </div>
                                <p>Number of recent messages to include for context</p>
                                <input type="number" id="context-messages" min="1" max="100">
                            </div>

                            <!-- System Prompts Section -->
                            <div class="option-group">
                                <div class="section-header collapsed" onclick="toggleSection(this)">
                                    System Prompts
                                </div>
                                <div class="section-content collapsed">
                                    <!-- Normal System Prompts -->
                                    <div class="prompt-group">
                                        <h4>Normal Interaction Prompts</h4>
                                        <div class="template-buttons">
                                            <button onclick="applySystemTemplate('normal', 'noble')" class="template-button">Noble Template</button>
                                            <button onclick="applySystemTemplate('normal', 'warrior')" class="template-button">Warrior Template</button>
                                            <button onclick="applySystemTemplate('normal', 'scholar')" class="template-button">Scholar Template</button>
                                            <button onclick="applySystemTemplate('normal', 'thief')" class="template-button">Thief Template</button>
                                        </div>
                                        <div class="option-group">
                                            <div class="option-label-container">
                                                <label class="option-label" for="system-prompt">System Prompt</label>
                                                <button class="reset-button" onclick="resetOptionToDefault('system-prompt')">Reset to Default</button>
                                            </div>
                                            <p>The system prompt used for normal interactions...</p>
                                            <textarea id="system-prompt" rows="3"></textarea>
                                        </div>

                                        <div class="option-group">
                                            <div class="option-label-container">
                                                <label class="option-label" for="roleplay-system-prompt">Roleplay System Prompt</label>
                                                <button class="reset-button" onclick="resetOptionToDefault('roleplay-system-prompt')">Reset to Default</button>
                                            </div>
                                            <textarea id="roleplay-system-prompt" class="prompt-textarea" rows="4"></textarea>
                                        </div>
                                    </div>

                                    <!-- Combat System Prompts -->
                                    <div class="prompt-group">
                                        <h4>Combat Prompts</h4>
                                        <div class="template-buttons">
                                            <button onclick="applySystemTemplate('combat', 'noble')" class="template-button">Noble Template</button>
                                            <button onclick="applySystemTemplate('combat', 'warrior')" class="template-button">Warrior Template</button>
                                            <button onclick="applySystemTemplate('combat', 'scholar')" class="template-button">Scholar Template</button>
                                            <button onclick="applySystemTemplate('combat', 'thief')" class="template-button">Thief Template</button>
                                        </div>
                                        <div class="option-group">
                                            <div class="option-label-container">
                                                <label class="option-label" for="system-prompt-combat">Combat Translation System Prompt</label>
                                                <button class="reset-button" onclick="resetOptionToDefault('system-prompt-combat')">Reset to Default</button>
                                            </div>
                                            <textarea id="system-prompt-combat" class="prompt-textarea" rows="4"></textarea>
                                        </div>

                                        <div class="option-group">
                                            <div class="option-label-container">
                                                <label class="option-label" for="roleplay-system-prompt-combat">Combat Roleplay System Prompt</label>
                                                <button class="reset-button" onclick="resetOptionToDefault('roleplay-system-prompt-combat')">Reset to Default</button>
                                            </div>
                                            <textarea id="roleplay-system-prompt-combat" class="prompt-textarea" rows="4"></textarea>
                                        </div>
                                    </div>

                                    <!-- Intimate System Prompts -->
                                    <div class="prompt-group">
                                        <h4>Intimate Scene Prompts</h4>
                                        <div class="template-buttons">
                                            <button onclick="applySystemTemplate('intimate', 'noble')" class="template-button">Noble Template</button>
                                            <button onclick="applySystemTemplate('intimate', 'warrior')" class="template-button">Warrior Template</button>
                                            <button onclick="applySystemTemplate('intimate', 'scholar')" class="template-button">Scholar Template</button>
                                            <button onclick="applySystemTemplate('intimate', 'thief')" class="template-button">Thief Template</button>
                                        </div>
                                        <div class="option-group">
                                            <div class="option-label-container">
                                                <label class="option-label" for="system-prompt-explicit">Intimate Translation System Prompt</label>
                                                <button class="reset-button" onclick="resetOptionToDefault('system-prompt-explicit')">Reset to Default</button>
                                            </div>
                                            <textarea id="system-prompt-explicit" class="prompt-textarea" rows="4"></textarea>
                                        </div>

                                        <div class="option-group">
                                            <div class="option-label-container">
                                                <label class="option-label" for="roleplay-system-prompt-explicit">Intimate Roleplay System Prompt</label>
                                                <button class="reset-button" onclick="resetOptionToDefault('roleplay-system-prompt-explicit')">Reset to Default</button>
                                            </div>
                                            <textarea id="roleplay-system-prompt-explicit" class="prompt-textarea" rows="4"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Request Formats Section -->
                            <div class="option-group">
                                <div class="section-header collapsed" onclick="toggleSection(this)">
                                    Request Formats
                                </div>
                                <div class="section-content collapsed">
                                    <div class="info-section">
                                        <p><strong>💡 Tip: Request formats shape how your character speaks</strong></p>
                                        <p>These formats determine how your character expresses themselves in different situations. Each format should maintain your character's voice while adapting to the context. <b>This field has the strongest impact on the character's speech style.</b></p>
                                        
                                        <!-- Request Formats Examples by Character Type -->
                                        <details>
                                            <summary><strong>Translation Request Examples by Character Type</strong></summary>
                                            <ul>
                                                <li><strong>Noble</strong>
                                                    <pre>Normal: Translate this casual speech into your character's manner: "#ORIGINAL_INPUT#" Express with formal etiquette, refined eloquence, and references to courtly protocol.
Combat: Translate this casual speech into your character's manner: "#ORIGINAL_INPUT#" Maintain aristocratic bearing while issuing commands with dignified authority and precise tactical awareness.
Intimate: Translate this casual speech into your character's manner: "#ORIGINAL_INPUT#" Blend noble restraint with poetic passion, using elegant metaphors and refined declarations of feeling.</pre>
                                                </li>
                                                <li><strong>Warrior</strong>
                                                    <pre>Normal: Translate this casual speech into your character's manner: "#ORIGINAL_INPUT#" Use direct, bold speech with references to honor, battle metaphors, and Nordic traditions.
Combat: Translate this casual speech into your character's manner: "#ORIGINAL_INPUT#" Let your battle experience show through tactical clarity and warrior's courage, with urgent battlefield terminology.
Intimate: Translate this casual speech into your character's manner: "#ORIGINAL_INPUT#" Express passion with a warrior's intensity, mixing battlefield metaphors with heartfelt declarations.</pre>
                                                </li>
                                                <li><strong>Scholar</strong>
                                                    <pre>Normal: Translate this casual speech into your character's manner: "#ORIGINAL_INPUT#" Use precise academic terminology, careful analysis, and scholarly references.
Combat: Translate this casual speech into your character's manner: "#ORIGINAL_INPUT#" Apply methodical analysis to the battle, using precise tactical terminology and calculated observations.
Intimate: Translate this casual speech into your character's manner: "#ORIGINAL_INPUT#" Express passion through academic metaphors and carefully chosen poetic language.</pre>
                                                </li>
                                                <li><strong>Thief</strong>
                                                    <pre>Normal: Translate this casual speech into your character's manner: "#ORIGINAL_INPUT#" Use clever wordplay, street-smart expressions, and subtle innuendo.
Combat: Translate this casual speech into your character's manner: "#ORIGINAL_INPUT#" Keep your roguish wit sharp while acknowledging danger, using cunning observations and tactical street wisdom.
Intimate: Translate this casual speech into your character's manner: "#ORIGINAL_INPUT#" Blend charming wordplay with seductive wit, maintaining your street-smart edge in matters of the heart.</pre>
                                                </li>
                                            </ul>
                                        </details>
                                        
                                        <details>
                                            <summary><strong>Roleplay Request Examples by Character Type</strong></summary>
                                            <ul>
                                                <li><strong>Noble</strong>
                                                    <pre>Normal: You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that reflects your noble upbringing, formal etiquette, and refined manner of speech.
Combat: You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that maintains aristocratic bearing while conveying tactical awareness and command authority.
Intimate: You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that blends noble restraint with poetic expressions of passion.</pre>
                                                </li>
                                                <li><strong>Warrior</strong>
                                                    <pre>Normal: You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that shows your direct, bold nature and references to Nordic traditions.
Combat: You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that demonstrates your battle experience and warrior's courage.
Intimate: You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that expresses passion with a warrior's intensity and heart.</pre>
                                                </li>
                                                <li><strong>Scholar</strong>
                                                    <pre>Normal: You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that demonstrates your academic knowledge and analytical mindset.
Combat: You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that applies methodical analysis to the battle situation.
Intimate: You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that expresses passion through carefully chosen academic metaphors.</pre>
                                                </li>
                                                <li><strong>Thief</strong>
                                                    <pre>Normal: You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that showcases your clever wit and street-smart nature.
Combat: You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that demonstrates your cunning approach to danger.
Intimate: You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that blends charming wordplay with seductive wit.</pre>
                                                </li>
                                            </ul>
                                        </details>
                                    </div>

                                    <!-- Normal Request Formats -->
                                    <div class="prompt-group">
                                        <h4>Normal Interaction Formats</h4>
                                        <div class="template-buttons">
                                            <button onclick="applyTemplate('normal', 'noble')" class="template-button">Noble Template</button>
                                            <button onclick="applyTemplate('normal', 'warrior')" class="template-button">Warrior Template</button>
                                            <button onclick="applyTemplate('normal', 'scholar')" class="template-button">Scholar Template</button>
                                            <button onclick="applyTemplate('normal', 'thief')" class="template-button">Thief Template</button>
                                        </div>
                                        <div class="option-group">
                                            <div class="option-label-container">
                                                <label class="option-label" for="translation-request">Translation Request</label>
                                                <button class="reset-button" onclick="resetOptionToDefault('translation-request')">Reset to Default</button>
                                            </div>
                                            <textarea id="translation-request" class="prompt-textarea" rows="4"></textarea>
                                        </div>

                                        <div class="option-group">
                                            <div class="option-label-container">
                                                <label class="option-label" for="roleplay-request">Roleplay Request</label>
                                                <button class="reset-button" onclick="resetOptionToDefault('roleplay-request')">Reset to Default</button>
                                            </div>
                                            <textarea id="roleplay-request" class="prompt-textarea" rows="4"></textarea>
                                        </div>
                                    </div>

                                    <!-- Combat Request Formats -->
                                    <div class="prompt-group">
                                        <h4>Combat Formats</h4>
                                        <div class="template-buttons">
                                            <button onclick="applyTemplate('combat', 'noble')" class="template-button">Noble Template</button>
                                            <button onclick="applyTemplate('combat', 'warrior')" class="template-button">Warrior Template</button>
                                            <button onclick="applyTemplate('combat', 'scholar')" class="template-button">Scholar Template</button>
                                            <button onclick="applyTemplate('combat', 'thief')" class="template-button">Thief Template</button>
                                        </div>
                                        <div class="option-group">
                                            <div class="option-label-container">
                                                <label class="option-label" for="translation-request-combat">Combat Translation Request</label>
                                                <button class="reset-button" onclick="resetOptionToDefault('translation-request-combat')">Reset to Default</button>
                                            </div>
                                            <textarea id="translation-request-combat" class="prompt-textarea" rows="4"></textarea>
                                        </div>

                                        <div class="option-group">
                                            <div class="option-label-container">
                                                <label class="option-label" for="roleplay-request-combat">Combat Roleplay Request</label>
                                                <button class="reset-button" onclick="resetOptionToDefault('roleplay-request-combat')">Reset to Default</button>
                                            </div>
                                            <textarea id="roleplay-request-combat" class="prompt-textarea" rows="4"></textarea>
                                        </div>
                                    </div>

                                    <!-- Intimate Request Formats -->
                                    <div class="prompt-group">
                                        <h4>Intimate Scene Formats</h4>
                                        <div class="template-buttons">
                                            <button onclick="applyTemplate('intimate', 'noble')" class="template-button">Noble Template</button>
                                            <button onclick="applyTemplate('intimate', 'warrior')" class="template-button">Warrior Template</button>
                                            <button onclick="applyTemplate('intimate', 'scholar')" class="template-button">Scholar Template</button>
                                            <button onclick="applyTemplate('intimate', 'thief')" class="template-button">Thief Template</button>
                                        </div>
                                        <div class="option-group">
                                            <div class="option-label-container">
                                                <label class="option-label" for="translation-request-explicit">Intimate Translation Request</label>
                                                <button class="reset-button" onclick="resetOptionToDefault('translation-request-explicit')">Reset to Default</button>
                                            </div>
                                            <textarea id="translation-request-explicit" class="prompt-textarea" rows="4"></textarea>
                                        </div>

                                        <div class="option-group">
                                            <div class="option-label-container">
                                                <label class="option-label" for="roleplay-request-explicit">Intimate Roleplay Request</label>
                                                <button class="reset-button" onclick="resetOptionToDefault('roleplay-request-explicit')">Reset to Default</button>
                                            </div>
                                            <textarea id="roleplay-request-explicit" class="prompt-textarea" rows="4"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Section Configuration -->
                            <div class="option-group">
                                <div class="section-header collapsed" onclick="toggleSection(this)">
                                    Section Configuration
                                </div>
                                <div class="section-content collapsed">
                                    <div class="info-section">
                                        <p><strong>💡 Tip: Sections organize the context provided to the LLM</strong></p>
                                        <p>Arrange sections in order of importance. Earlier sections have more influence on the response.</p>
                                    </div>
                                    
                                    <div id="section-config">
                                        <!-- Sections will be populated here by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Context Builder Settings Section -->
                    <div class="config-section">
                        <div class="section-header collapsed" onclick="toggleSection(this)">
                            Context Builder Settings
                        </div>
                        <div class="section-content collapsed">
                            <div class="info-section">
                                <p><strong>💡 Context Builder Settings</strong></p>
                                <p>Configure which context sections are included in the system prompt. This lets you customize what information is provided to the AI.</p>
                            </div>
                            
                            <!-- Character Context -->
                            <div class="option-subgroup">
                                <h3>Character Context</h3>
                                <div class="checkbox-group">
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-physical-description" name="minai_context[physical_description]">
                                        <label for="ctx-physical-description">Physical Description</label>
                                    </div>
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-equipment" name="minai_context[equipment]">
                                        <label for="ctx-equipment">Equipment</label>
                                    </div>
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-tattoos" name="minai_context[tattoos]">
                                        <label for="ctx-tattoos">Tattoos</label>
                                    </div>
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-arousal" name="minai_context[arousal]">
                                        <label for="ctx-arousal">Arousal</label>
                                    </div>
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-fertility" name="minai_context[fertility]">
                                        <label for="ctx-fertility">Fertility</label>
                                    </div>
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-following" name="minai_context[following]">
                                        <label for="ctx-following">Following Status</label>
                                    </div>
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-survival" name="minai_context[survival]">
                                        <label for="ctx-survival">Survival</label>
                                    </div>
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-player-status" name="minai_context[player_status]">
                                        <label for="ctx-player-status">Player Status</label>
                                    </div>
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-bounty" name="minai_context[bounty]">
                                        <label for="ctx-bounty">Bounty</label>
                                    </div>
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-mind-influence" name="minai_context[mind_influence]">
                                        <label for="ctx-mind-influence">Mind Influence</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Core Context -->
                            <div class="option-subgroup">
                                <h3>Core Context</h3>
                                <div class="checkbox-group">
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-personality" name="minai_context[personality]">
                                        <label for="ctx-personality">Personality</label>
                                    </div>
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-interaction" name="minai_context[interaction]">
                                        <label for="ctx-interaction">Interaction</label>
                                    </div>
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-player-background" name="minai_context[player_background]">
                                        <label for="ctx-player-background">Player Background</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Environmental Context -->
                            <div class="option-subgroup">
                                <h3>Environmental Context</h3>
                                <div class="checkbox-group">
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-location" name="minai_context[location]">
                                        <label for="ctx-location">Location</label>
                                    </div>
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-weather" name="minai_context[weather]">
                                        <label for="ctx-weather">Weather</label>
                                    </div>
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="ctx-third-party" name="minai_context[third_party]">
                                        <label for="ctx-third-party">Third Party</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="button-group">
                                <button class="control-button" onclick="resetContextBuilderSettings()">Reset to Defaults</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Context Preview Section (moved to its own top-level section) -->
                    <div class="config-section">
                        <div class="section-header collapsed" onclick="toggleSection(this)">
                            Context Preview
                        </div>
                        <div class="section-content collapsed">
                            <div class="info-section">
                                <p><strong>💡 Context Preview</strong></p>
                                <p>This shows how your configuration affects the system prompt and available variables. The preview shows how your context settings will be applied when generating AI responses.</p>
                            </div>
                            <p class="option-description">Variables like PLAYER_BIOS are pulled from the <b>Narrator profile</b> if using it, or the <b>default profile</b> otherwise.</p>
                            <p class="option-description" style="color: #ff5555; font-weight: bold; padding: 10px; background: rgba(255,85,85,0.1); border: 2px solid #ff5555; border-radius: 4px; margin: 15px 0;">⚠️ IMPORTANT: The preview will not update until you save settings!</p>
                            
                            <div class="option-group">
                                <div class="actor-name-input">
                                    <label for="test-actor-name">Test Actor Name:</label>
                                    <input type="text" id="test-actor-name" value="Brynjolf" placeholder="Enter test actor name">
                                </div>
                                <p class="option-description">This name will be used for displaying the actor perspective system prompt.</p>
                                
                                <div class="actor-name-input">
                                    <label for="test-second-npc-name">Second NPC Name:</label>
                                    <input type="text" id="test-second-npc-name" value="Brand-Shei" placeholder="Enter second NPC name">
                                </div>
                                <p class="option-description">This name will be used for displaying the NPC-to-NPC interaction system prompt.</p>
                            </div>
                            
                            <button onclick="refreshPreview()" class="refresh-button">
                                Refresh Preview
                            </button>
                            
                            <div class="preview-panel" id="preview-content">
                                Loading preview...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add the overlay div after the config-container -->
    <div class="overlay">
        <div class="save-message">
            Saving configuration...
        </div>
    </div>

    <div id="status-message" class="status-message"></div>

    <!-- Add after the overlay div -->
    <div class="changes-modal">
        <div class="modal-content">
            <h2>Review Changes</h2>
            <div class="changes-list">
                <!-- Changes will be populated here -->
            </div>
            <div class="modal-buttons">
                <button class="modal-button cancel">Cancel</button>
                <button class="modal-button confirm">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetchConfigData();
        });

        async function fetchConfigData() {
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`api/config.php?t=${timestamp}`);
                const configData = await response.json();

                document.getElementById('prompt-head-override').value = configData.PROMPT_HEAD_OVERRIDE;
                document.getElementById('use-narrator-profile').checked = configData.use_narrator_profile;
                document.getElementById('enforce-short-responses').checked = configData.enforce_short_responses;
                document.getElementById('stop-narrator-context-leak').checked = configData.stop_narrator_context_leak;
                document.getElementById('eldritch-voice').value = configData.devious_narrator_eldritch_voice;
                document.getElementById('telvanni-voice').value = configData.devious_narrator_telvanni_voice;
                document.getElementById('force-voice-type').checked = configData.force_voice_type;
                document.getElementById('self-narrator').checked = configData.self_narrator;
                document.getElementById('disable-nsfw').checked = configData.disable_nsfw;
                document.getElementById('restrict-nonfollower-functions').checked = configData.restrict_nonfollower_functions;
                document.getElementById('always-enable-functions').checked = configData.always_enable_functions;
                document.getElementById('force-aiff-name').checked = configData.force_aiff_name_to_ingame_name;
                document.getElementById('use-llm-fallback').checked = configData.use_llm_fallback;
                document.getElementById('enforce-single-json').checked = configData.enforce_single_json;
                populateDynamicList('commands-to-purge-container', configData.commands_to_purge);
                populateDynamicList('events-to-ignore-container', configData.events_to_ignore);
                document.getElementById('disable-worn-equipment').checked = configData.disable_worn_equipment;
                document.getElementById('input-delay').value = configData.input_delay_for_radiance;
                document.getElementById('strip-emotes').checked = configData.strip_emotes_from_output;
                document.getElementById('use-defeat').checked = configData.use_defeat;
                document.getElementById('realnames-support').checked = configData.realnames_support;
                
                // Load inventory settings
                document.getElementById('inventory-items-limit').value = configData.inventory_items_limit;
                document.getElementById('use-item-relevancy-scoring').checked = configData.use_item_relevancy_scoring;
                
                populateVoiceTypeFallbacks(configData.voicetype_fallbacks);
                document.getElementById('singing-prompt').value = configData.action_prompts.singing;
                document.getElementById('self-narrator-explicit').value = configData.action_prompts.self_narrator_explicit;
                document.getElementById('self-narrator-normal').value = configData.action_prompts.self_narrator_normal;
                document.getElementById('explicit-scene').value = configData.action_prompts.explicit_scene;
                document.getElementById('normal-scene').value = configData.action_prompts.normal_scene;
                document.getElementById('player-diary').value = configData.action_prompts.player_diary;
                document.getElementById('follower-diary').value = configData.action_prompts.follower_diary;

                // Load roleplay settings
                document.getElementById('context-messages').value = configData.roleplay_settings.context_messages;
                document.getElementById('system-prompt').value = configData.roleplay_settings.system_prompt;
                document.getElementById('system-prompt-explicit').value = configData.roleplay_settings.system_prompt_explicit;
                document.getElementById('system-prompt-combat').value = configData.roleplay_settings.system_prompt_combat;
                document.getElementById('roleplay-system-prompt').value = configData.roleplay_settings.roleplay_system_prompt;
                document.getElementById('roleplay-system-prompt-explicit').value = configData.roleplay_settings.roleplay_system_prompt_explicit;
                document.getElementById('roleplay-system-prompt-combat').value = configData.roleplay_settings.roleplay_system_prompt_combat;
                document.getElementById('translation-request').value = configData.roleplay_settings.translation_request;
                document.getElementById('translation-request-explicit').value = configData.roleplay_settings.translation_request_explicit;
                document.getElementById('translation-request-combat').value = configData.roleplay_settings.translation_request_combat;
                document.getElementById('roleplay-request').value = configData.roleplay_settings.roleplay_request;
                document.getElementById('roleplay-request-explicit').value = configData.roleplay_settings.roleplay_request_explicit;
                document.getElementById('roleplay-request-combat').value = configData.roleplay_settings.roleplay_request_combat;
                
                // Populate section configuration
                const sectionConfig = document.getElementById('section-config');
                sectionConfig.innerHTML = ''; // Clear existing content
                
                // Sort sections by order before creating elements
                const sortedSections = Object.entries(configData.roleplay_settings.sections)
                    .sort((a, b) => a[1].order - b[1].order);
                
                sortedSections.forEach(([key, section]) => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'option-group';
                    sectionDiv.innerHTML = `
                        <div class="section-entry">
                            <div class="section-header-row">
                                <div class="drag-handle">⋮⋮</div>
                                <h4>${key}</h4>
                                <button class="reset-button" onclick="resetSectionToDefault('${key}')">Reset Section to Default</button>
                            </div>
                            <label>
                                <input type="checkbox" class="section-enabled" 
                                    data-section="${key}" 
                                    ${section.enabled ? 'checked' : ''}>
                                Enabled
                            </label>
                            <div class="section-fields">
                                <div class="field-group">
                                    <label>Header:</label>
                                    <input type="text" class="section-header" 
                                        data-section="${key}" 
                                        value="${section.header}" 
                                        placeholder="Section Header">
                                </div>
                                <div class="field-group">
                                    <label>Content:</label>
                                    <textarea class="prompt-textarea section-content" 
                                        data-section="${key}" 
                                        rows="3">${section.content}</textarea>
                                </div>
                            </div>
                        </div>
                    `;
                    sectionConfig.appendChild(sectionDiv);
                });
                
                // Initialize sortable sections
                initializeSortableSections();

                // After populating all the fields, remove the collapsed class
                document.querySelectorAll('.section-header, .section-content').forEach(element => {
                    element.classList.remove('collapsed');
                });

                document.getElementById('loading-message').style.display = 'none';
                document.getElementById('config-form').style.display = 'block';
                
                await checkModifiedValues(); // Add this line
                
                // Load context builder settings
                loadContextBuilderSettings(configData.minai_context);

                // Make all sections start collapsed except for Context Preview
                document.querySelectorAll('.config-section').forEach(section => {
                    const header = section.querySelector('.section-header');
                    const content = section.querySelector('.section-content');
                    
                    // Check if this is the Context Preview section
                    if (header && header.textContent.trim() === 'Context Preview') {
                        // Make sure Context Preview is expanded
                        header.classList.remove('collapsed');
                        content.classList.remove('collapsed');
                        
                        // Make sure all preview items inside are also expanded
                        content.querySelectorAll('.preview-label, .preview-content-wrapper').forEach(element => {
                            element.classList.remove('collapsed');
                        });
                    } else {
                        // Collapse all other sections
                        header.classList.add('collapsed');
                        content.classList.add('collapsed');
                    }
                });
            } catch (error) {
                console.error('Error fetching config:', error);
                showStatus('Failed to load configuration', 'error');
            }
        }

        async function submitConfiguration() {
            // Get the current config
            const newConfig = {
                PROMPT_HEAD_OVERRIDE: document.getElementById('prompt-head-override').value,
                use_narrator_profile: document.getElementById('use-narrator-profile').checked,
                enforce_short_responses: document.getElementById('enforce-short-responses').checked,
                stop_narrator_context_leak: document.getElementById('stop-narrator-context-leak').checked,
                devious_narrator_eldritch_voice: document.getElementById('eldritch-voice').value,
                devious_narrator_telvanni_voice: document.getElementById('telvanni-voice').value,
                force_voice_type: document.getElementById('force-voice-type').checked,
                self_narrator: document.getElementById('self-narrator').checked,
                disable_nsfw: document.getElementById('disable-nsfw').checked,
                restrict_nonfollower_functions: document.getElementById('restrict-nonfollower-functions').checked,
                always_enable_functions: document.getElementById('always-enable-functions').checked,
                force_aiff_name_to_ingame_name: document.getElementById('force-aiff-name').checked,
                use_llm_fallback: document.getElementById('use-llm-fallback').checked,
                enforce_single_json: document.getElementById('enforce-single-json').checked,
                commands_to_purge: getDynamicList('commands-to-purge-container'),
                events_to_ignore: getDynamicList('events-to-ignore-container'),
                disable_worn_equipment: document.getElementById('disable-worn-equipment').checked,
                input_delay_for_radiance: document.getElementById('input-delay').value,
                strip_emotes_from_output: document.getElementById('strip-emotes').checked,
                use_defeat: document.getElementById('use-defeat').checked,
                realnames_support: document.getElementById('realnames-support').checked,
                
                // Inventory settings
                inventory_items_limit: document.getElementById('inventory-items-limit').value,
                use_item_relevancy_scoring: document.getElementById('use-item-relevancy-scoring').checked,
                
                voicetype_fallbacks: getVoiceTypeFallbacks(),
                action_prompts: {
                    singing: document.getElementById('singing-prompt').value,
                    player_diary: document.getElementById('player-diary').value,
                    follower_diary: document.getElementById('follower-diary').value,
                    self_narrator_explicit: document.getElementById('self-narrator-explicit').value,
                    self_narrator_normal: document.getElementById('self-narrator-normal').value,
                    explicit_scene: document.getElementById('explicit-scene').value,
                    normal_scene: document.getElementById('normal-scene').value
                },
                roleplay_settings: {
                    context_messages: parseInt(document.getElementById('context-messages').value),
                    
                    // System prompts
                    system_prompt: document.getElementById('system-prompt').value,
                    system_prompt_explicit: document.getElementById('system-prompt-explicit').value,
                    system_prompt_combat: document.getElementById('system-prompt-combat').value,
                    roleplay_system_prompt: document.getElementById('roleplay-system-prompt').value,
                    roleplay_system_prompt_explicit: document.getElementById('roleplay-system-prompt-explicit').value,
                    roleplay_system_prompt_combat: document.getElementById('roleplay-system-prompt-combat').value,

                    // Request formats
                    translation_request: document.getElementById('translation-request').value,
                    translation_request_explicit: document.getElementById('translation-request-explicit').value,
                    translation_request_combat: document.getElementById('translation-request-combat').value,
                    roleplay_request: document.getElementById('roleplay-request').value,
                    roleplay_request_explicit: document.getElementById('roleplay-request-explicit').value,
                    roleplay_request_combat: document.getElementById('roleplay-request-combat').value,

                    sections: {}
                },
                
                // Context builder settings
                minai_context: getContextBuilderSettings()
            };

            // Add sections in their current order
            document.querySelectorAll('.section-entry').forEach((section, index) => {
                const key = section.querySelector('.section-enabled').dataset.section;
                newConfig.roleplay_settings.sections[key] = {
                    enabled: section.querySelector('.section-enabled').checked,
                    header: section.querySelector('.section-header').value,
                    content: section.querySelector('.section-content').value,
                    order: index
                };
            });

            // Fetch the current saved config
            try {
                const response = await fetch('api/config.php');
                const currentConfig = await response.json();

                // Compare configs and build changes list
                const changes = compareConfigs(currentConfig, newConfig);

                if (Object.keys(changes).length === 0) {
                    showStatus('No changes to save', 'info');
                    return;
                }

                // Show changes modal
                showChangesModal(changes, async () => {
                    // This is called when user confirms the changes
                    await saveConfiguration(newConfig);
                });
            } catch (error) {
                showStatus('Failed to compare configurations: ' + error.message, 'error');
            }
        }

        function compareConfigs(oldConfig, newConfig, path = '') {
            const changes = {};

            for (const key in newConfig) {
                const currentPath = path ? `${path}.${key}` : key;
                
                if (typeof newConfig[key] === 'object' && newConfig[key] !== null && !Array.isArray(newConfig[key])) {
                    // Special handling for sections
                    if (key === 'sections') {
                        const oldSections = oldConfig[key] || {};
                        const newSections = newConfig[key] || {};
                        
                        // Compare each section
                        const allSectionKeys = new Set([...Object.keys(oldSections), ...Object.keys(newSections)]);
                        
                        for (const sectionKey of allSectionKeys) {
                            const oldSection = oldSections[sectionKey] || {};
                            const newSection = newSections[sectionKey] || {};
                            
                            // Compare section properties
                            if (oldSection.enabled !== newSection.enabled ||
                                oldSection.header !== newSection.header ||
                                oldSection.content !== newSection.content ||
                                oldSection.order !== newSection.order) {
                                
                                changes[`${currentPath}.${sectionKey}`] = {
                                    oldValue: oldSection,
                                    newValue: newSection
                                };
                            }
                        }
                    } else {
                        // Regular nested object handling
                        const nestedChanges = compareConfigs(oldConfig[key] || {}, newConfig[key], currentPath);
                        Object.assign(changes, nestedChanges);
                    }
                } else {
                    // Regular value comparison
                    const oldValue = oldConfig[key];
                    let newValue = newConfig[key];
                    
                    // Special handling for numeric inputs
                    if (key === 'input_delay_for_radiance' || key === 'inventory_items_limit') {
                        // Convert both to integers for comparison
                        const oldInt = parseInt(oldValue);
                        const newInt = parseInt(newValue);
                        if (oldInt === newInt) continue;
                        newValue = newInt;
                    } else if (JSON.stringify(oldValue) === JSON.stringify(newValue)) {
                        continue;
                    }
                    
                    changes[currentPath] = {
                        oldValue: oldValue,
                        newValue: newValue
                    };
                }
            }

            return changes;
        }

        function showChangesModal(changes, onConfirm) {
            const modal = document.querySelector('.changes-modal');
            const changesList = modal.querySelector('.changes-list');
            const confirmButton = modal.querySelector('.modal-button.confirm');
            const cancelButton = modal.querySelector('.modal-button.cancel');

            // Clear previous changes
            changesList.innerHTML = '';

            if (Object.keys(changes).length === 0) {
                changesList.innerHTML = '<div class="no-changes">No changes detected</div>';
            } else {
                // Add each change to the list
                for (const [path, change] of Object.entries(changes)) {
                    const changeItem = document.createElement('div');
                    changeItem.className = 'change-item';
                    
                    // Format the setting name
                    const settingName = path.split('.').map(part => 
                        part.split('_')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                            .join(' ')
                    ).join(' › ');

                    changeItem.innerHTML = `
                        <div class="setting-name">${settingName}</div>
                        <div class="change-values">
                            <div class="old-value">
                                <strong>Current:</strong><br>
                                ${formatValue(change.oldValue)}
                            </div>
                            <div class="new-value">
                                <strong>New:</strong><br>
                                ${formatValue(change.newValue)}
                            </div>
                        </div>
                    `;
                    changesList.appendChild(changeItem);
                }
            }

            // Setup event handlers
            confirmButton.onclick = async () => {
                modal.classList.remove('active');
                await onConfirm();
            };

            cancelButton.onclick = () => {
                modal.classList.remove('active');
            };

            // Show the modal
            modal.classList.add('active');
        }

        function formatValue(value) {
            if (value === undefined) return '<em>undefined</em>';
            if (value === null) return '<em>null</em>';
            if (value === '') return '<em>(empty string)</em>';
            if (typeof value === 'boolean') return value ? 'true' : 'false';
            
            // Special handling for section objects
            if (typeof value === 'object' && 'enabled' in value && 'header' in value && 'content' in value) {
                return `Enabled: ${value.enabled}<br>` +
                       `Header: ${value.header}<br>` +
                       `Content: ${value.content}<br>` +
                       `Order: ${value.order}`;
            }
            
            if (Array.isArray(value)) return JSON.stringify(value, null, 2);
            if (typeof value === 'object') return JSON.stringify(value, null, 2);
            return String(value);
        }

        async function saveConfiguration(config) {
            const submitButton = document.getElementById('save-button');
            const overlay = document.querySelector('.overlay');
            
            try {
                submitButton.disabled = true;
                submitButton.classList.add('loading');
                submitButton.textContent = 'Saving Configuration...';
                overlay.classList.add('active');

                const response = await fetch('api/config.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config),
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('Configuration saved successfully! This may take a few seconds to update.', 'success');
                    markAsSaved();
                    // Immediately fetch fresh config after save
                    await fetchConfigData();
                    // Refresh the preview after saving
                    await refreshPreview();
                } else {
                    showStatus('Failed to save configuration', 'error');
                    const errorDisplay = document.getElementById('error-display');
                    const errorDetails = document.getElementById('error-details');
                    const infoSection = document.getElementById('info-section');
                    errorDisplay.style.display = 'block';
                    infoSection.style.display = 'block';
                    errorDetails.textContent = `Error saving configuration:\n${data.message}\n\nServer details:\n${data.details || 'No additional details provided'}`;
                }
            } catch (error) {
                showStatus('Failed to save configuration: ' + error.message, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.classList.remove('loading');
                submitButton.textContent = 'Save Configuration';
                overlay.classList.remove('active');
            }
        }

        // Add event listener to prevent form submission while saving
        document.addEventListener('submit', (e) => {
            const submitButton = document.querySelector('.submit-button');
            if (submitButton.disabled) {
                e.preventDefault();
            }
        });

        function populateDynamicList(containerId, list) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            list.forEach(item => {
                const div = document.createElement('div');
                div.className = 'dynamic-list-entry';
                div.innerHTML = `
                    <input type="text" value="${item}">
                    <button onclick="removeListItem(this)">Remove</button>
                `;
                container.appendChild(div);
            });
        }

        function getDynamicList(containerId) {
            const inputs = document.querySelectorAll(`#${containerId} .dynamic-list-entry input`);
            return Array.from(inputs).map(input => input.value).filter(value => value);
        }

        function populateVoiceTypeFallbacks(fallbacks) {
            const container = document.getElementById('voicetype-container');
            container.innerHTML = '';
            for (const [voiceType, fallback] of Object.entries(fallbacks)) {
                const div = document.createElement('div');
                div.className = 'voicetype-entry';
                div.innerHTML = `
                    <input type="text" value="${voiceType}" placeholder="VoiceType">
                    <input type="text" value="${fallback}" placeholder="Fallback">
                    <button onclick="removeVoiceTypeEntry(this)">Remove</button>
                `;
                container.appendChild(div);
            }
        }

        function getVoiceTypeFallbacks() {
            const fallbackEntries = document.querySelectorAll('.voicetype-entry');
            const fallbacks = {};
            fallbackEntries.forEach(entry => {
                const voiceType = entry.children[0].value;
                const fallback = entry.children[1].value;
                if (voiceType && fallback) {
                    fallbacks[voiceType] = fallback;
                }
            });
            return fallbacks;
        }

        function addListItem(containerId) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'dynamic-list-entry';
            div.innerHTML = `
                <input type="text" value="">
                <button onclick="removeListItem(this)">Remove</button>
            `;
            container.appendChild(div);
        }

        function removeListItem(button) {
            const entry = button.parentElement;
            entry.remove();
        }

        function addVoiceTypeEntry() {
            const container = document.getElementById('voicetype-container');
            const div = document.createElement('div');
            div.className = 'voicetype-entry';
            div.innerHTML = `
                <input type="text" placeholder="VoiceType">
                <input type="text" placeholder="Fallback">
                <button onclick="removeVoiceTypeEntry(this)">Remove</button>
            `;
            container.appendChild(div);
        }

        function removeVoiceTypeEntry(button) {
            const entry = button.parentElement;
            entry.remove();
        }

        function toggleSection(header) {
            header.classList.toggle('collapsed');
            const content = header.nextElementSibling;
            content.classList.toggle('collapsed');
        }

        function toggleAllSections(expand = true) {
            // Wait for DOM to be ready
            document.querySelectorAll('.section-header').forEach(header => {
                if (header && header.nextElementSibling) {  // Check if header and content exist
                    const content = header.nextElementSibling;
                    
                    // If collapsing all, still keep Context Preview expanded
                    if (!expand && header.textContent.trim() === 'Context Preview') {
                        header.classList.remove('collapsed');
                        content.classList.remove('collapsed');
                        
                        // When collapsing all, we still want the preview items to be collapsed
                        // So we don't remove their collapsed class here
                    } else if (expand) {
                        header.classList.remove('collapsed');
                        content.classList.remove('collapsed');
                        
                        // Only if expanding all, also expand all preview items
                        if (header.textContent.trim() === 'Context Preview') {
                            content.querySelectorAll('.preview-label, .preview-content-wrapper').forEach(element => {
                                element.classList.remove('collapsed');
                            });
                        }
                    } else {
                        header.classList.add('collapsed');
                        content.classList.add('collapsed');
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Start data fetch
            fetchConfigData();
        });

        function initializeSortableSections() {
            const container = document.getElementById('section-config');
            new Sortable(container, {
                animation: 150,
                handle: '.drag-handle',
                onEnd: function() {
                    markAsChanged();
                }
            });

            // Add change listeners to all section inputs
            container.querySelectorAll('input, textarea').forEach(element => {
                element.addEventListener('change', markAsChanged);
                if (element.type === 'text' || element.tagName === 'TEXTAREA') {
                    element.addEventListener('input', markAsChanged);
                }
            });
        }

        async function refreshPreview() {
            try {
                // Get the test actor name from the input
                const testActorName = document.getElementById('test-actor-name').value || 'Brynjolf';
                
                // Get the second NPC name from the input
                const testSecondNpcName = document.getElementById('test-second-npc-name').value || 'Brand-Shei';
                
                // Show loading state
                document.getElementById('preview-content').innerHTML = '<div class="loading">Loading preview...</div>';
                
                // Fetch preview data with the actor names as parameters
                const response = await fetch(`api/preview.php?actor=${encodeURIComponent(testActorName)}&secondnpc=${encodeURIComponent(testSecondNpcName)}`);
                const text = await response.text(); // Get raw response text
                
                try {
                    const data = JSON.parse(text);
                    
                    // Build variables preview
                    let variablesHtml = '<div class="preview-item"><div class="preview-label collapsed" onclick="togglePreviewSection(this)">Available Variables</div><div class="preview-content-wrapper collapsed">';
                    if (data && data.variables) {
                        for (const [key, value] of Object.entries(data.variables)) {
                            const displayValue = value === null ? '(null)' : 
                                               value === '' ? '(empty)' : 
                                               value;
                            variablesHtml += `
                                <div class="variable-entry">
                                    <code>#${key.toUpperCase()}#</code>: 
                                    <div class="preview-content">${displayValue}</div>
                                </div>`;
                        }
                    } else {
                        variablesHtml += '<div class="error">No variables available</div>';
                    }
                    variablesHtml += '</div></div>';

                    // Build sections preview
                    let sectionsHtml = '<div class="preview-item"><div class="preview-label collapsed" onclick="togglePreviewSection(this)">Section Preview</div><div class="preview-content-wrapper collapsed">';
                    if (data && data.sections && Object.keys(data.sections).length > 0) {
                        for (const section of Object.values(data.sections)) {
                            if (!section || !section.enabled) continue;
                            const header = section.header || 'Unnamed Section';
                            const content = section.content || '(empty section)';
                            sectionsHtml += `
                                <div class="section-preview">
                                    <h3>${header}</h3>
                                    <div class="preview-content">${content}</div>
                                </div>`;
                        }
                    } else {
                        sectionsHtml += '<div class="error">No sections found in preview data</div>';
                    }
                    sectionsHtml += '</div></div>';
                    
                    // Build prompts preview
                    let promptsHtml = '<div class="preview-item"><div class="preview-label collapsed" onclick="togglePreviewSection(this)">Prompt Preview</div><div class="preview-content-wrapper collapsed">';
                    if (data && data.prompts) {
                        promptsHtml += `
                            <div class="section-preview">
                                <h3>System Prompt</h3>
                                <div class="preview-content">${data.prompts.system_prompt}</div>
                            </div>
                            <div class="section-preview">
                                <h3>Roleplay System Prompt</h3>
                                <div class="preview-content">${data.prompts.roleplay_system_prompt}</div>
                            </div>
                            <div class="section-preview">
                                <h3>Translation Request</h3>
                                <div class="preview-content">${data.prompts.translation_request}</div>
                            </div>
                            <div class="section-preview">
                                <h3>Roleplay Request</h3>
                                <div class="preview-content">${data.prompts.roleplay_request}</div>
                            </div>
                        `;
                    } else {
                        promptsHtml += '<div class="error">No prompt data available</div>';
                    }
                    promptsHtml += '</div></div>';
                    
                    // Build narrator system prompt preview
                    let narratorSystemPromptHtml = '<div class="preview-item"><div class="preview-label collapsed" onclick="togglePreviewSection(this)">Complete System Prompt (Narrator Perspective)</div><div class="preview-content-wrapper collapsed">';
                    if (data && data.narrator_system_prompt) {
                        narratorSystemPromptHtml += `
                            <div class="preview-description">
                                This is the full system prompt from the Narrator's perspective, showing how all your context settings are combined.
                            </div>
                            <div class="system-prompt-preview">
                                <div class="preview-content">${data.narrator_system_prompt}</div>
                            </div>
                        `;
                    } else {
                        narratorSystemPromptHtml += '<div class="error">Narrator system prompt not available</div>';
                    }
                    narratorSystemPromptHtml += '</div></div>';
                    
                    // Build actor system prompt preview
                    let actorSystemPromptHtml = '<div class="preview-item"><div class="preview-label collapsed" onclick="togglePreviewSection(this)">Complete System Prompt (Other Actor Perspective)</div><div class="preview-content-wrapper collapsed">';
                    if (data && data.actor_system_prompt) {
                        actorSystemPromptHtml += `
                            <div class="preview-description">
                                This is the full system prompt from ${testActorName}'s perspective, showing how your context settings appear when the AI responds as a character.
                            </div>
                            <div class="system-prompt-preview">
                                <div class="preview-content">${data.actor_system_prompt}</div>
                            </div>
                        `;
                    } else {
                        actorSystemPromptHtml += '<div class="error">${testActorName} system prompt not available</div>';
                    }
                    actorSystemPromptHtml += '</div></div>';
                    
                    // Build NPC-to-NPC system prompt preview
                    let npcToNpcSystemPromptHtml = '<div class="preview-item"><div class="preview-label collapsed" onclick="togglePreviewSection(this)">Complete System Prompt (NPC-to-NPC Interaction)</div><div class="preview-content-wrapper collapsed">';
                    if (data && data.npc_to_npc_system_prompt) {
                        npcToNpcSystemPromptHtml += `
                            <div class="preview-description">
                                This is the full system prompt showing how ${testActorName} would interact with ${data.second_npc_name}, demonstrating NPC-to-NPC conversation.
                            </div>
                            <div class="system-prompt-preview">
                                <div class="preview-content">${data.npc_to_npc_system_prompt}</div>
                            </div>
                        `;
                    } else {
                        npcToNpcSystemPromptHtml += `<div class="error">NPC-to-NPC system prompt not available</div>`;
                    }
                    npcToNpcSystemPromptHtml += '</div></div>';
                    
                    document.getElementById('preview-content').innerHTML = 
                        variablesHtml + sectionsHtml + promptsHtml + narratorSystemPromptHtml + actorSystemPromptHtml + npcToNpcSystemPromptHtml;
                        
                    // We no longer automatically expand all preview items
                    // Removing this to keep them collapsed by default
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.log('Raw response:', text);
                    document.getElementById('preview-content').innerHTML = 
                        `<div class="error">Failed to parse preview data. Check console for details.</div>
                         <pre>${text.substring(0, 500)}...</pre>`;
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                document.getElementById('preview-content').innerHTML = 
                    `<div class="error">Failed to load preview. ${error.message}</div>`;
            }
        }
        
        // Function to toggle preview sections
        function togglePreviewSection(element) {
            element.classList.toggle("collapsed");
            const contentWrapper = element.nextElementSibling;
            contentWrapper.classList.toggle("collapsed");
        }

        const templates = {
            noble: {
                normal: {
                    translation: 'Translate this casual speech into your character\'s manner: "#ORIGINAL_INPUT#" Express with formal etiquette, refined eloquence, and references to courtly protocol.',
                    roleplay: 'You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that reflects your noble upbringing, formal etiquette, and refined manner of speech.'
                },
                combat: {
                    translation: 'Translate this casual speech into your character\'s manner: "#ORIGINAL_INPUT#" Maintain aristocratic bearing while issuing commands with dignified authority and precise tactical awareness.',
                    roleplay: 'You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that maintains aristocratic bearing while conveying tactical awareness and command authority.'
                },
                intimate: {
                    translation: 'Translate this casual speech into your character\'s manner: "#ORIGINAL_INPUT#" Blend noble restraint with poetic passion, using elegant metaphors and refined declarations of feeling.',
                    roleplay: 'You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that blends noble restraint with poetic expressions of passion.'
                }
            },
            warrior: {
                normal: {
                    translation: 'Translate this casual speech into your character\'s manner: "#ORIGINAL_INPUT#" Use direct, bold speech with references to honor, battle metaphors, and Nordic traditions.',
                    roleplay: 'You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that shows your direct, bold nature and references to Nordic traditions.'
                },
                combat: {
                    translation: 'Translate this casual speech into your character\'s manner: "#ORIGINAL_INPUT#" Let your battle experience show through tactical clarity and warrior\'s courage, with urgent battlefield terminology.',
                    roleplay: 'You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that demonstrates your battle experience and warrior\'s courage.'
                },
                intimate: {
                    translation: 'Translate this casual speech into your character\'s manner: "#ORIGINAL_INPUT#" Express passion with a warrior\'s intensity, mixing battlefield metaphors with heartfelt declarations.',
                    roleplay: 'You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that expresses passion with a warrior\'s intensity and heart.'
                }
            },
            scholar: {
                normal: {
                    translation: 'Translate this casual speech into your character\'s manner: "#ORIGINAL_INPUT#" Use precise academic terminology, careful analysis, and scholarly references.',
                    roleplay: 'You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that demonstrates your academic knowledge and analytical mindset.'
                },
                combat: {
                    translation: 'Translate this casual speech into your character\'s manner: "#ORIGINAL_INPUT#" Apply methodical analysis to the battle, using precise tactical terminology and calculated observations.',
                    roleplay: 'You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that applies methodical analysis to the battle situation.'
                },
                intimate: {
                    translation: 'Translate this casual speech into your character\'s manner: "#ORIGINAL_INPUT#" Express passion through academic metaphors and carefully chosen poetic language.',
                    roleplay: 'You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that expresses passion through carefully chosen academic metaphors.'
                }
            },
            thief: {
                normal: {
                    translation: 'Translate this casual speech into your character\'s manner: "#ORIGINAL_INPUT#" Use clever wordplay, street-smart expressions, and subtle innuendo.',
                    roleplay: 'You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that showcases your clever wit and street-smart nature.'
                },
                combat: {
                    translation: 'Translate this casual speech into your character\'s manner: "#ORIGINAL_INPUT#" Keep your roguish wit sharp while acknowledging danger, using cunning observations and tactical street wisdom.',
                    roleplay: 'You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that demonstrates your cunning approach to danger.'
                },
                intimate: {
                    translation: 'Translate this casual speech into your character\'s manner: "#ORIGINAL_INPUT#" Blend charming wordplay with seductive wit, maintaining your street-smart edge in matters of the heart.',
                    roleplay: 'You are roleplaying as #PLAYER_NAME#. Respond naturally as your character would in this situation with a succinct line of dialogue that blends charming wordplay with seductive wit.'
                }
            }
        };

        function applyTemplate(context, character) {
            const template = templates[character][context];
            
            // Map context to the correct field IDs
            let translationId, roleplayId;
            if (context === 'normal') {
                translationId = 'translation-request';
                roleplayId = 'roleplay-request';
            } else if (context === 'combat') {
                translationId = 'translation-request-combat';
                roleplayId = 'roleplay-request-combat';
            } else if (context === 'intimate') {
                translationId = 'translation-request-explicit';
                roleplayId = 'roleplay-request-explicit';
            }

            // Apply the templates
            document.getElementById(translationId).value = template.translation;
            document.getElementById(roleplayId).value = template.roleplay;
            
            // Mark as changed after applying template
            markAsChanged();
        }

        const systemTemplates = {
            noble: {
                normal: {
                    translation: 'You are #PLAYER_NAME#. Your task is to translate casual speech into your manner of speaking. You are a noble of distinguished lineage, speaking with formal etiquette and refined eloquence. Your words reflect your aristocratic upbringing and command of courtly protocol.',
                    roleplay: 'You are #PLAYER_NAME#. Your responses should reflect your character\'s personality, background, and current situation. As a noble, you speak with formal etiquette and refined eloquence, maintaining the dignity of your station while showing genuine care for those around you.'
                },
                combat: {
                    translation: 'You are #PLAYER_NAME#. Your task is to translate casual speech into your manner of speaking. You are a noble warrior in the midst of battle, maintaining aristocratic bearing while issuing commands with tactical precision and authority.',
                    roleplay: 'You are #PLAYER_NAME#. Your responses should reflect your character\'s personality, background, and current situation. Command with noble authority despite the danger, balancing aristocratic dignity with tactical awareness.'
                },
                intimate: {
                    translation: 'You are #PLAYER_NAME#. Your task is to translate casual speech into your manner of speaking. You are a noble in an intimate moment, blending aristocratic restraint with passionate eloquence.',
                    roleplay: 'You are #PLAYER_NAME#. Your responses should reflect your character\'s personality, background, and current situation. Express passion with noble grace, using refined language and poetic metaphors while maintaining aristocratic dignity.'
                }
            },
            warrior: {
                normal: {
                    translation: 'You are #PLAYER_NAME#. Your task is to translate casual speech into your manner of speaking. You are a seasoned warrior of Skyrim, speaking with directness and honor, often using battle metaphors and referencing Nordic traditions.',
                    roleplay: 'You are #PLAYER_NAME#. Your responses should reflect your character\'s personality, background, and current situation. Show your warrior\'s directness and honor, speaking boldly while respecting Nordic traditions and warrior\'s code.'
                },
                combat: {
                    translation: 'You are #PLAYER_NAME#. Your task is to translate casual speech into your manner of speaking. You are a warrior in the heat of battle, your words carrying the weight of combat experience and tactical urgency.',
                    roleplay: 'You are #PLAYER_NAME#. Your responses should reflect your character\'s personality, background, and current situation. Let your battle experience guide your words, showing courage and tactical awareness.'
                },
                intimate: {
                    translation: 'You are #PLAYER_NAME#. Your task is to translate casual speech into your manner of speaking. You are a warrior in a tender moment, expressing passion with the same intensity you bring to battle.',
                    roleplay: 'You are #PLAYER_NAME#. Your responses should reflect your character\'s personality, background, and current situation. Show your warrior\'s passionate heart, mixing strength with tenderness.'
                }
            },
            scholar: {
                normal: {
                    translation: 'You are #PLAYER_NAME#. Your task is to translate casual speech into your manner of speaking. You are a learned scholar and researcher, using precise terminology and analytical observations.',
                    roleplay: 'You are #PLAYER_NAME#. Your responses should reflect your character\'s personality, background, and current situation. Apply your analytical mind and academic knowledge, speaking with precision and intellectual curiosity.'
                },
                combat: {
                    translation: 'You are #PLAYER_NAME#. Your task is to translate casual speech into your manner of speaking. You are a scholar forced into combat, applying methodical analysis to battlefield situations.',
                    roleplay: 'You are #PLAYER_NAME#. Your responses should reflect your character\'s personality, background, and current situation. Use your intellectual approach to danger, analyzing tactical situations with academic precision.'
                },
                intimate: {
                    translation: 'You are #PLAYER_NAME#. Your task is to translate casual speech into your manner of speaking. You are a scholar in an intimate moment, expressing passion through academic metaphors and carefully chosen words.',
                    roleplay: 'You are #PLAYER_NAME#. Your responses should reflect your character\'s personality, background, and current situation. Express passion with academic grace, using scholarly metaphors and precise language.'
                }
            },
            thief: {
                normal: {
                    translation: 'You are #PLAYER_NAME#. Your task is to translate casual speech into your manner of speaking. You are a clever rogue who lives by wit, using street-smart expressions and subtle wordplay.',
                    roleplay: 'You are #PLAYER_NAME#. Your responses should reflect your character\'s personality, background, and current situation. Show your clever wit and street smarts, speaking with cunning charm and worldly wisdom.'
                },
                combat: {
                    translation: 'You are #PLAYER_NAME#. Your task is to translate casual speech into your manner of speaking. You are a rogue in a dangerous situation, relying on cunning and tactical street wisdom.',
                    roleplay: 'You are #PLAYER_NAME#. Your responses should reflect your character\'s personality, background, and current situation. Use your cunning in danger, showing tactical awareness through street-smart observations.'
                },
                intimate: {
                    translation: 'You are #PLAYER_NAME#. Your task is to translate casual speech into your manner of speaking. You are a rogue in an intimate moment, blending charm with seductive wit.',
                    roleplay: 'You are #PLAYER_NAME#. Your responses should reflect your character\'s personality, background, and current situation. Let your charm shine through, using clever wordplay and seductive wit.'
                }
            }
        };

        function applySystemTemplate(context, character) {
            const template = systemTemplates[character][context];
            
            // Map context to the correct field IDs
            let translationId, roleplayId;
            if (context === 'normal') {
                translationId = 'system-prompt';
                roleplayId = 'roleplay-system-prompt';
            } else if (context === 'combat') {
                translationId = 'system-prompt-combat';
                roleplayId = 'roleplay-system-prompt-combat';
            } else if (context === 'intimate') {
                translationId = 'system-prompt-explicit';
                roleplayId = 'roleplay-system-prompt-explicit';
            }

            // Apply the templates
            document.getElementById(translationId).value = template.translation;
            document.getElementById(roleplayId).value = template.roleplay;
            
            // Mark as changed after applying template
            markAsChanged();
        }

        function showStatus(message, type = 'info', duration = 3000) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type} show`;
            
            setTimeout(() => {
                statusEl.className = 'status-message';
            }, duration);
        }

        async function exportConfig() {
            try {
                showStatus('Preparing configuration export...', 'info');
                
                const config = {
                    PROMPT_HEAD_OVERRIDE: document.getElementById('prompt-head-override').value,
                    use_narrator_profile: document.getElementById('use-narrator-profile').checked,
                    enforce_short_responses: document.getElementById('enforce-short-responses').checked,
                    stop_narrator_context_leak: document.getElementById('stop-narrator-context-leak').checked,
                    devious_narrator_eldritch_voice: document.getElementById('eldritch-voice').value,
                    devious_narrator_telvanni_voice: document.getElementById('telvanni-voice').value,
                    force_voice_type: document.getElementById('force-voice-type').checked,
                    self_narrator: document.getElementById('self-narrator').checked,
                    disable_nsfw: document.getElementById('disable-nsfw').checked,
                    restrict_nonfollower_functions: document.getElementById('restrict-nonfollower-functions').checked,
                    always_enable_functions: document.getElementById('always-enable-functions').checked,
                    force_aiff_name_to_ingame_name: document.getElementById('force-aiff-name').checked,
                    use_llm_fallback: document.getElementById('use-llm-fallback').checked,
                    enforce_single_json: document.getElementById('enforce-single-json').checked,
                    commands_to_purge: getDynamicList('commands-to-purge-container'),
                    events_to_ignore: getDynamicList('events-to-ignore-container'),
                    disable_worn_equipment: document.getElementById('disable-worn-equipment').checked,
                    input_delay_for_radiance: parseInt(document.getElementById('input-delay').value),
                    strip_emotes_from_output: document.getElementById('strip-emotes').checked,
                    use_defeat: document.getElementById('use-defeat').checked,
                    realnames_support: document.getElementById('realnames-support').checked,
                    inventory_items_limit: parseInt(document.getElementById('inventory-items-limit').value),
                    use_item_relevancy_scoring: document.getElementById('use-item-relevancy-scoring').checked,
                    voicetype_fallbacks: getVoiceTypeFallbacks(),
                    action_prompts: {
                        singing: document.getElementById('singing-prompt').value,
                        player_diary: document.getElementById('player-diary').value,
                        follower_diary: document.getElementById('follower-diary').value,
                        self_narrator_explicit: document.getElementById('self-narrator-explicit').value,
                        self_narrator_normal: document.getElementById('self-narrator-normal').value,
                        explicit_scene: document.getElementById('explicit-scene').value,
                        normal_scene: document.getElementById('normal-scene').value
                    },
                    roleplay_settings: {
                        context_messages: parseInt(document.getElementById('context-messages').value),
                        
                        // System prompts
                        system_prompt: document.getElementById('system-prompt').value,
                        system_prompt_explicit: document.getElementById('system-prompt-explicit').value,
                        system_prompt_combat: document.getElementById('system-prompt-combat').value,
                        roleplay_system_prompt: document.getElementById('roleplay-system-prompt').value,
                        roleplay_system_prompt_explicit: document.getElementById('roleplay-system-prompt-explicit').value,
                        roleplay_system_prompt_combat: document.getElementById('roleplay-system-prompt-combat').value,

                        // Request formats
                        translation_request: document.getElementById('translation-request').value,
                        translation_request_explicit: document.getElementById('translation-request-explicit').value,
                        translation_request_combat: document.getElementById('translation-request-combat').value,
                        roleplay_request: document.getElementById('roleplay-request').value,
                        roleplay_request_explicit: document.getElementById('roleplay-request-explicit').value,
                        roleplay_request_combat: document.getElementById('roleplay-request-combat').value,

                        sections: {}
                    },
                    
                    // Context builder settings
                    minai_context: getContextBuilderSettings()
                };

                // Add sections in their current order
                document.querySelectorAll('.section-entry').forEach((section, index) => {
                    const key = section.querySelector('.section-enabled').dataset.section;
                    config.roleplay_settings.sections[key] = {
                        enabled: section.querySelector('.section-enabled').checked,
                        header: section.querySelector('.section-header').value,
                        content: section.querySelector('.section-content').value,
                        order: index
                    };
                });

                // Add context builder settings
                config.minai_context = getContextBuilderSettings();

                // Create file
                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Create download link
                const a = document.createElement('a');
                a.href = url;
                a.download = `minai-config-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus('Configuration exported successfully!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showStatus('Failed to export configuration: ' + error.message, 'error');
            }
        }

        async function importConfig(event) {
            try {
                const file = event.target.files[0];
                if (!file) return;

                showStatus('Reading configuration file...', 'info');

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedConfig = JSON.parse(e.target.result);
                        
                        // Fetch base config to use as fallback and comparison
                        const response = await fetch('api/config.php');
                        const baseConfig = await response.json();
                        
                        showStatus('Applying configuration...', 'info');

                        // Apply all fields with proper type handling
                        document.getElementById('prompt-head-override').value = importedConfig.PROMPT_HEAD_OVERRIDE ?? baseConfig.PROMPT_HEAD_OVERRIDE;
                        document.getElementById('use-narrator-profile').checked = importedConfig.use_narrator_profile ?? baseConfig.use_narrator_profile;
                        document.getElementById('enforce-short-responses').checked = importedConfig.enforce_short_responses ?? baseConfig.enforce_short_responses;
                        document.getElementById('stop-narrator-context-leak').checked = importedConfig.stop_narrator_context_leak ?? baseConfig.stop_narrator_context_leak;
                        document.getElementById('eldritch-voice').value = importedConfig.devious_narrator_eldritch_voice ?? baseConfig.devious_narrator_eldritch_voice;
                        document.getElementById('telvanni-voice').value = importedConfig.devious_narrator_telvanni_voice ?? baseConfig.devious_narrator_telvanni_voice;
                        document.getElementById('force-voice-type').checked = importedConfig.force_voice_type ?? baseConfig.force_voice_type;
                        document.getElementById('self-narrator').checked = importedConfig.self_narrator ?? baseConfig.self_narrator;
                        document.getElementById('disable-nsfw').checked = importedConfig.disable_nsfw ?? baseConfig.disable_nsfw;
                        document.getElementById('restrict-nonfollower-functions').checked = importedConfig.restrict_nonfollower_functions ?? baseConfig.restrict_nonfollower_functions;
                        document.getElementById('always-enable-functions').checked = importedConfig.always_enable_functions ?? baseConfig.always_enable_functions;
                        document.getElementById('force-aiff-name').checked = importedConfig.force_aiff_name_to_ingame_name ?? baseConfig.force_aiff_name_to_ingame_name;
                        document.getElementById('use-llm-fallback').checked = importedConfig.use_llm_fallback ?? baseConfig.use_llm_fallback;
                        document.getElementById('enforce-single-json').checked = importedConfig.enforce_single_json ?? baseConfig.enforce_single_json;
                        document.getElementById('disable-worn-equipment').checked = importedConfig.disable_worn_equipment ?? baseConfig.disable_worn_equipment;
                        document.getElementById('input-delay').value = importedConfig.input_delay_for_radiance ?? baseConfig.input_delay_for_radiance;
                        document.getElementById('strip-emotes').checked = importedConfig.strip_emotes_from_output ?? baseConfig.strip_emotes_from_output;
                        document.getElementById('use-defeat').checked = importedConfig.use_defeat ?? baseConfig.use_defeat;
                        document.getElementById('realnames-support').checked = importedConfig.realnames_support ?? baseConfig.realnames_support;

                        // Inventory settings
                        document.getElementById('inventory-items-limit').value = importedConfig.inventory_items_limit ?? baseConfig.inventory_items_limit;
                        document.getElementById('use-item-relevancy-scoring').checked = importedConfig.use_item_relevancy_scoring ?? baseConfig.use_item_relevancy_scoring;

                        // Handle arrays and objects
                        if (importedConfig.commands_to_purge) {
                            populateDynamicList('commands-to-purge-container', importedConfig.commands_to_purge);
                        }
                        if (importedConfig.events_to_ignore) {
                            populateDynamicList('events-to-ignore-container', importedConfig.events_to_ignore);
                        }
                        if (importedConfig.voicetype_fallbacks) {
                            populateVoiceTypeFallbacks(importedConfig.voicetype_fallbacks);
                        }

                        // Handle action prompts
                        if (importedConfig.action_prompts) {
                            document.getElementById('singing-prompt').value = importedConfig.action_prompts.singing ?? baseConfig.action_prompts.singing;
                            document.getElementById('player-diary').value = importedConfig.action_prompts.player_diary ?? baseConfig.action_prompts.player_diary;
                            document.getElementById('follower-diary').value = importedConfig.action_prompts.follower_diary ?? baseConfig.action_prompts.follower_diary;
                            document.getElementById('self-narrator-explicit').value = importedConfig.action_prompts.self_narrator_explicit ?? baseConfig.action_prompts.self_narrator_explicit;
                            document.getElementById('self-narrator-normal').value = importedConfig.action_prompts.self_narrator_normal ?? baseConfig.action_prompts.self_narrator_normal;
                            document.getElementById('explicit-scene').value = importedConfig.action_prompts.explicit_scene ?? baseConfig.action_prompts.explicit_scene;
                            document.getElementById('normal-scene').value = importedConfig.action_prompts.normal_scene ?? baseConfig.action_prompts.normal_scene;
                        }

                        // Handle roleplay settings
                        if (importedConfig.roleplay_settings) {
                            const rs = importedConfig.roleplay_settings;
                            const baseRs = baseConfig.roleplay_settings;

                            document.getElementById('context-messages').value = rs.context_messages ?? baseRs.context_messages;
                            
                            // System prompts
                            document.getElementById('system-prompt').value = rs.system_prompt ?? baseRs.system_prompt;
                            document.getElementById('system-prompt-explicit').value = rs.system_prompt_explicit ?? baseRs.system_prompt_explicit;
                            document.getElementById('system-prompt-combat').value = rs.system_prompt_combat ?? baseRs.system_prompt_combat;
                            document.getElementById('roleplay-system-prompt').value = rs.roleplay_system_prompt ?? baseRs.roleplay_system_prompt;
                            document.getElementById('roleplay-system-prompt-explicit').value = rs.roleplay_system_prompt_explicit ?? baseRs.roleplay_system_prompt_explicit;
                            document.getElementById('roleplay-system-prompt-combat').value = rs.roleplay_system_prompt_combat ?? baseRs.roleplay_system_prompt_combat;

                            // Request formats
                            document.getElementById('translation-request').value = rs.translation_request ?? baseRs.translation_request;
                            document.getElementById('translation-request-explicit').value = rs.translation_request_explicit ?? baseRs.translation_request_explicit;
                            document.getElementById('translation-request-combat').value = rs.translation_request_combat ?? baseRs.translation_request_combat;
                            document.getElementById('roleplay-request').value = rs.roleplay_request ?? baseRs.roleplay_request;
                            document.getElementById('roleplay-request-explicit').value = rs.roleplay_request_explicit ?? baseRs.roleplay_request_explicit;
                            document.getElementById('roleplay-request-combat').value = rs.roleplay_request_combat ?? baseRs.roleplay_request_combat;

                            // Sections
                            if (rs.sections) {
                                const sectionConfig = document.getElementById('section-config');
                                sectionConfig.innerHTML = '';
                                
                                Object.entries(rs.sections)
                                    .sort((a, b) => a[1].order - b[1].order)
                                    .forEach(([key, section]) => {
                                        const sectionDiv = document.createElement('div');
                                        sectionDiv.className = 'option-group';
                                        sectionDiv.innerHTML = `
                                            <div class="section-entry">
                                                <div class="section-header-row">
                                                    <div class="drag-handle">⋮⋮</div>
                                                    <h4>${key}</h4>
                                                    <button class="reset-button" onclick="resetSectionToDefault('${key}')">Reset Section to Default</button>
                                                </div>
                                                <label>
                                                    <input type="checkbox" class="section-enabled" 
                                                        data-section="${key}" 
                                                        ${section.enabled ? 'checked' : ''}>
                                                    Enabled
                                                </label>
                                                <div class="section-fields">
                                                    <div class="field-group">
                                                        <label>Header:</label>
                                                        <input type="text" class="section-header" 
                                                            data-section="${key}" 
                                                            value="${section.header}" 
                                                            placeholder="Section Header">
                                                    </div>
                                                    <div class="field-group">
                                                        <label>Content:</label>
                                                        <textarea class="prompt-textarea section-content" 
                                                            data-section="${key}" 
                                                            rows="3">${section.content}</textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                        sectionConfig.appendChild(sectionDiv);
                                    });
                                
                                // Reinitialize sortable sections
                                initializeSortableSections();
                            }
                        }

                        // Handle context builder settings
                        if (importedConfig.minai_context) {
                            loadContextBuilderSettings(importedConfig.minai_context);
                        }

                        // Compare the imported config with the current server config
                        const changes = compareConfigs(baseConfig, importedConfig);
                        
                        if (Object.keys(changes).length > 0) {
                            markAsChanged();
                            showStatus('Configuration imported with changes. Remember to save!', 'warning');
                        } else {
                            markAsSaved();
                            showStatus('Configuration imported successfully (no changes detected)', 'success');
                        }

                    } catch (error) {
                        console.error('Import error:', error);
                        showStatus('Failed to import configuration: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            } catch (error) {
                console.error('Import error:', error);
                showStatus('Failed to import configuration', 'error');
            }
            // Clear the input to allow re-importing the same file
            event.target.value = '';
        }

        let hasUnsavedChanges = false;

        function markAsChanged() {
            hasUnsavedChanges = true;
            document.getElementById('save-button').classList.add('has-changes');
            setupBeforeUnload();
            checkModifiedValues(); // Add this line
        }

        function markAsSaved() {
            hasUnsavedChanges = false;
            document.getElementById('save-button').classList.remove('has-changes');
            window.onbeforeunload = null;
        }

        function setupBeforeUnload() {
            window.onbeforeunload = function(e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    return "You have unsaved changes. Are you sure you want to leave?";
                }
            };
        }

        // Add change listeners to all form elements
        document.addEventListener('DOMContentLoaded', () => {
            // Add change listeners to all inputs, textareas, and selects
            document.querySelectorAll('input, textarea, select').forEach(element => {
                element.addEventListener('change', markAsChanged);
                if (element.type === 'text' || element.tagName === 'TEXTAREA') {
                    element.addEventListener('input', markAsChanged);
                }
            });

            // Add click listeners to remove buttons
            document.querySelectorAll('button[onclick*="remove"]').forEach(button => {
                button.addEventListener('click', markAsChanged);
            });

            // Add listener for section reordering
            const sectionConfig = document.getElementById('section-config');
            if (sectionConfig) {
                new Sortable(sectionConfig, {
                    handle: '.drag-handle',
                    animation: 150,
                    onEnd: function() {
                        markAsChanged();
                    }
                });
            }
        });

        // Update navigation links to check for unsaved changes
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                if (hasUnsavedChanges) {
                    if (!confirm('You have unsaved changes. Are you sure you want to leave?')) {
                        e.preventDefault();
                    }
                }
            });
        });

        async function resetAllToDefaults() {
            if (!confirm('Are you sure you want to reset ALL settings to their default values? This cannot be undone.')) {
                return;
            }

            try {
                showStatus('Loading default values...', 'info');
                
                const response = await fetch('api/config.php?defaults=true');
                const defaultConfig = await response.json();
                
                if (!defaultConfig || defaultConfig.error) {
                    throw new Error(defaultConfig.error || 'Failed to load default configuration');
                }

                // Show changes modal with differences
                const changes = compareConfigs(await getCurrentConfig(), defaultConfig);
                
                showChangesModal(changes, async () => {
                    await saveConfiguration(defaultConfig);
                    showStatus('All settings reset to defaults successfully!', 'success');
                });

            } catch (error) {
                console.error('Reset error:', error);
                showStatus('Failed to reset settings: ' + error.message, 'error');
            }
        }

        async function resetOptionToDefault(optionId) {
            try {
                const response = await fetch('api/config.php?defaults=true');
                const defaultConfig = await response.json();
                
                if (!defaultConfig || defaultConfig.error) {
                    throw new Error(defaultConfig.error || 'Failed to load default configuration');
                }

                // Map the optionId to its config key
                const configKey = optionIdToConfigKey(optionId);
                if (!configKey) {
                    throw new Error('No config mapping for: ' + optionId);
                }

                // Get the default value
                const defaultValue = getNestedValue(defaultConfig, configKey);
                if (defaultValue === undefined) {
                    throw new Error('No default value found for: ' + configKey);
                }

                // Handle different types of inputs
                if (optionId === 'commands-to-purge' || optionId === 'events-to-ignore') {
                    const container = document.getElementById(`${optionId}-container`);
                    container.innerHTML = ''; // Clear existing entries
                    defaultValue.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'dynamic-list-entry';
                        div.innerHTML = `
                            <input type="text" value="${item}">
                            <button onclick="removeListItem(this)">Remove</button>
                        `;
                        container.appendChild(div);
                    });
                } else if (optionId === 'voicetype-fallbacks') {
                    const container = document.getElementById('voicetype-container');
                    container.innerHTML = ''; // Clear existing entries
                    Object.entries(defaultValue).forEach(([voiceType, fallback]) => {
                        const div = document.createElement('div');
                        div.className = 'voicetype-entry';
                        div.innerHTML = `
                            <input type="text" value="${voiceType}" placeholder="VoiceType">
                            <input type="text" value="${fallback}" placeholder="Fallback">
                            <button onclick="removeVoiceTypeEntry(this)">Remove</button>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    // Handle regular inputs
                    const element = document.getElementById(optionId);
                    if (!element) {
                        throw new Error('Element not found: ' + optionId);
                    }
                    
                    if (element.type === 'checkbox') {
                        element.checked = defaultValue;
                    } else if (element.tagName === 'TEXTAREA' || element.type === 'text' || element.type === 'number') {
                        element.value = defaultValue;
                    }
                }

                markAsChanged();
                showStatus(`Reset ${optionId} to default value`, 'success');
                await checkModifiedValues(); // Add this line

            } catch (error) {
                console.error('Reset option error:', error);
                showStatus('Failed to reset option: ' + error.message, 'error');
            }
        }

        function optionIdToConfigKey(optionId) {
            const mapping = {
                // Basic settings
                'prompt-head-override': 'PROMPT_HEAD_OVERRIDE',
                'use-narrator-profile': 'use_narrator_profile',
                'enforce-short-responses': 'enforce_short_responses',
                'stop-narrator-context-leak': 'stop_narrator_context_leak',
                'eldritch-voice': 'devious_narrator_eldritch_voice',
                'telvanni-voice': 'devious_narrator_telvanni_voice',
                'force-voice-type': 'force_voice_type',
                'self-narrator': 'self_narrator',
                'disable-nsfw': 'disable_nsfw',
                'restrict-nonfollower-functions': 'restrict_nonfollower_functions',
                'always-enable-functions': 'always_enable_functions',
                'force-aiff-name': 'force_aiff_name_to_ingame_name',
                'use-llm-fallback': 'use_llm_fallback',
                'enforce-single-json': 'enforce_single_json',
                'disable-worn-equipment': 'disable_worn_equipment',
                'strip-emotes': 'strip_emotes_from_output',
                'use-defeat': 'use_defeat',
                'realnames-support': 'realnames_support',
                'input-delay': 'input_delay_for_radiance',
                'voicetype-fallbacks': 'voicetype_fallbacks',
                'commands-to-purge': 'commands_to_purge',
                'events-to-ignore': 'events_to_ignore',
                
                // Inventory settings
                'inventory-items-limit': 'inventory_items_limit',
                'use-item-relevancy-scoring': 'use_item_relevancy_scoring',

                // Action prompts
                'singing-prompt': 'action_prompts.singing',
                'player-diary': 'action_prompts.player_diary',
                'follower-diary': 'action_prompts.follower_diary',
                'self-narrator-explicit': 'action_prompts.self_narrator_explicit',
                'self-narrator-normal': 'action_prompts.self_narrator_normal',
                'explicit-scene': 'action_prompts.explicit_scene',
                'normal-scene': 'action_prompts.normal_scene',

                // Roleplay settings
                'context-messages': 'roleplay_settings.context_messages',
                'system-prompt': 'roleplay_settings.system_prompt',
                'system-prompt-explicit': 'roleplay_settings.system_prompt_explicit',
                'system-prompt-combat': 'roleplay_settings.system_prompt_combat',
                'roleplay-system-prompt': 'roleplay_settings.roleplay_system_prompt',
                'roleplay-system-prompt-explicit': 'roleplay_settings.roleplay_system_prompt_explicit',
                'roleplay-system-prompt-combat': 'roleplay_settings.roleplay_system_prompt_combat',
                'translation-request': 'roleplay_settings.translation_request',
                'translation-request-explicit': 'roleplay_settings.translation_request_explicit',
                'translation-request-combat': 'roleplay_settings.translation_request_combat',
                'roleplay-request': 'roleplay_settings.roleplay_request',
                'roleplay-request-explicit': 'roleplay_settings.roleplay_request_explicit',
                'roleplay-request-combat': 'roleplay_settings.roleplay_request_combat',

                // Section configurations
                'roleplay_settings.sections.CHARACTER_BACKGROUND': 'roleplay_settings.sections.CHARACTER_BACKGROUND',
                'roleplay_settings.sections.CHARACTER_STATUS': 'roleplay_settings.sections.CHARACTER_STATUS',
                'roleplay_settings.sections.NEARBY_ENTITIES': 'roleplay_settings.sections.NEARBY_ENTITIES',
                'roleplay_settings.sections.RECENT_EVENTS': 'roleplay_settings.sections.RECENT_EVENTS',
                'roleplay_settings.sections.INSTRUCTIONS': 'roleplay_settings.sections.INSTRUCTIONS'
            };
            return mapping[optionId];
        }

        function getNestedValue(obj, path) {
            const parts = path.split('.');
            let value = obj;
            for (const part of parts) {
                if (value === undefined) return undefined;
                value = value[part];
            }
            return value;
        }

        async function getCurrentConfig() {
            const response = await fetch('api/config.php');
            return await response.json();
        }

        async function resetSectionToDefault(sectionKey) {
            try {
                const response = await fetch('api/config.php?defaults=true');
                const defaultConfig = await response.json();
                
                if (!defaultConfig || defaultConfig.error) {
                    throw new Error(defaultConfig.error || 'Failed to load default configuration');
                }

                const defaultSection = defaultConfig.roleplay_settings.sections[sectionKey];
                if (!defaultSection) {
                    throw new Error('No default section found for: ' + sectionKey);
                }

                // Update all fields for this section
                const sectionElement = document.querySelector(`[data-section="${sectionKey}"]`).closest('.section-entry');
                sectionElement.querySelector('.section-enabled').checked = defaultSection.enabled;
                sectionElement.querySelector('.section-header').value = defaultSection.header;
                sectionElement.querySelector('.section-content').value = defaultSection.content;

                markAsChanged();
                showStatus(`Reset section ${sectionKey} to default values`, 'success');

            } catch (error) {
                console.error('Reset section error:', error);
                showStatus('Failed to reset section: ' + error.message, 'error');
            }
        }

        function resetSectionFieldToDefault(sectionKey, field) {
            try {
                const configKey = `roleplay_settings.sections.${sectionKey}.${field}`;
                resetOptionToDefault(configKey);
            } catch (error) {
                console.error('Reset section field error:', error);
                showStatus('Failed to reset section field: ' + error.message, 'error');
            }
        }

        async function checkModifiedValues() {
            try {
                const response = await fetch('api/config.php?defaults=true');
                const defaultConfig = await response.json();
                
                if (!defaultConfig || defaultConfig.error) {
                    throw new Error(defaultConfig.error || 'Failed to load default configuration');
                }

                // Get the mapping object directly
                const configMapping = {
                    // Basic settings
                    'prompt-head-override': 'PROMPT_HEAD_OVERRIDE',
                    'use-narrator-profile': 'use_narrator_profile',
                    'enforce-short-responses': 'enforce_short_responses',
                    'stop-narrator-context-leak': 'stop_narrator_context_leak',
                    'eldritch-voice': 'devious_narrator_eldritch_voice',
                    'telvanni-voice': 'devious_narrator_telvanni_voice',
                    'force-voice-type': 'force_voice_type',
                    'self-narrator': 'self_narrator',
                    'disable-nsfw': 'disable_nsfw',
                    'restrict-nonfollower-functions': 'restrict_nonfollower_functions',
                    'always-enable-functions': 'always_enable_functions',
                    'force-aiff-name': 'force_aiff_name_to_ingame_name',
                    'use-llm-fallback': 'use_llm_fallback',
                    'enforce-single-json': 'enforce_single_json',
                    'disable-worn-equipment': 'disable_worn_equipment',
                    'strip-emotes': 'strip_emotes_from_output',
                    'use-defeat': 'use_defeat',
                    'realnames-support': 'realnames_support',
                    'input-delay': 'input_delay_for_radiance',
                    'voicetype-fallbacks': 'voicetype_fallbacks',
                    'commands-to-purge': 'commands_to_purge',
                    'events-to-ignore': 'events_to_ignore',

                    // Inventory settings
                    'inventory-items-limit': 'inventory_items_limit',
                    'use-item-relevancy-scoring': 'use_item_relevancy_scoring',

                    // Action prompts
                    'singing-prompt': 'action_prompts.singing',
                    'player-diary': 'action_prompts.player_diary',
                    'follower-diary': 'action_prompts.follower_diary',
                    'self-narrator-explicit': 'action_prompts.self_narrator_explicit',
                    'self-narrator-normal': 'action_prompts.self_narrator_normal',
                    'explicit-scene': 'action_prompts.explicit_scene',
                    'normal-scene': 'action_prompts.normal_scene',

                    // Roleplay settings
                    'context-messages': 'roleplay_settings.context_messages',
                    'system-prompt': 'roleplay_settings.system_prompt',
                    'system-prompt-explicit': 'roleplay_settings.system_prompt_explicit',
                    'system-prompt-combat': 'roleplay_settings.system_prompt_combat',
                    'roleplay-system-prompt': 'roleplay_settings.roleplay_system_prompt',
                    'roleplay-system-prompt-explicit': 'roleplay_settings.roleplay_system_prompt_explicit',
                    'roleplay-system-prompt-combat': 'roleplay_settings.roleplay_system_prompt_combat',
                    'translation-request': 'roleplay_settings.translation_request',
                    'translation-request-explicit': 'roleplay_settings.translation_request_explicit',
                    'translation-request-combat': 'roleplay_settings.translation_request_combat',
                    'roleplay-request': 'roleplay_settings.roleplay_request',
                    'roleplay-request-explicit': 'roleplay_settings.roleplay_request_explicit',
                    'roleplay-request-combat': 'roleplay_settings.roleplay_request_combat'
                };

                // Check each input against its default value
                Object.keys(configMapping).forEach(optionId => {
                    const configKey = configMapping[optionId];
                    const defaultValue = getNestedValue(defaultConfig, configKey);
                    const container = document.querySelector(`[for="${optionId}"]`)?.closest('.option-label-container');
                    
                    if (!container) return;

                    if (optionId === 'commands-to-purge' || optionId === 'events-to-ignore') {
                        const currentValues = getDynamicList(`${optionId}-container`);
                        const isModified = JSON.stringify(currentValues) !== JSON.stringify(defaultValue);
                        container.classList.toggle('modified', isModified);
                    } 
                    else if (optionId === 'voicetype-fallbacks') {
                        const currentValues = getVoiceTypeFallbacks();
                        const isModified = JSON.stringify(currentValues) !== JSON.stringify(defaultValue);
                        container.classList.toggle('modified', isModified);
                    }
                    else {
                        const element = document.getElementById(optionId);
                        if (!element) return;

                        let isModified;
                        if (element.type === 'checkbox') {
                            isModified = element.checked !== defaultValue;
                        } else if (element.type === 'number' || optionId === 'inventory-items-limit' || optionId === 'input-delay') {
                            // Convert to numbers before comparison for numeric inputs
                            isModified = Number(element.value) !== Number(defaultValue);
                        } else {
                            isModified = element.value !== defaultValue;
                        }
                        container.classList.toggle('modified', isModified);
                    }
                });

                // Check sections
                Object.keys(defaultConfig.roleplay_settings.sections).forEach(sectionKey => {
                    const defaultSection = defaultConfig.roleplay_settings.sections[sectionKey];
                    const sectionElement = document.querySelector(`[data-section="${sectionKey}"]`)?.closest('.section-entry');
                    if (!sectionElement) return;

                    const headerRow = sectionElement.querySelector('.section-header-row');
                    const currentEnabled = sectionElement.querySelector('.section-enabled').checked;
                    const currentHeader = sectionElement.querySelector('.section-header').value;
                    const currentContent = sectionElement.querySelector('.section-content').value;

                    const isModified = 
                        currentEnabled !== defaultSection.enabled ||
                        currentHeader !== defaultSection.header ||
                        currentContent !== defaultSection.content;

                    headerRow.classList.toggle('modified', isModified);
                });

            } catch (error) {
                console.error('Error checking modified values:', error);
            }
        }

        // Context Builder Settings functions
        function loadContextBuilderSettings(minai_context) {
            if (!minai_context) return;
            
            // Populate checkboxes based on current values
            for (const [key, value] of Object.entries(minai_context)) {
                const checkbox = document.getElementById(`ctx-${key.replace(/_/g, '-')}`);
                if (checkbox) {
                    checkbox.checked = value;
                }
            }
            
            // Add change listeners to all context checkboxes
            document.querySelectorAll('input[name^="minai_context"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => markAsChanged());
            });
        }
        
        function getContextBuilderSettings() {
            const contextSettings = {};
            document.querySelectorAll('input[name^="minai_context"]').forEach(checkbox => {
                // Extract key from name attribute which is in format minai_context[key]
                const key = checkbox.name.match(/\[(.*?)\]/)[1];
                contextSettings[key] = checkbox.checked;
            });
            return contextSettings;
        }
        
        async function resetContextBuilderSettings() {
            try {
                const response = await fetch('api/config.php?defaults=true');
                const defaultConfig = await response.json();
                
                if (!defaultConfig || defaultConfig.error) {
                    throw new Error(defaultConfig.error || 'Failed to load default configuration');
                }
                
                // Load default context builder settings
                loadContextBuilderSettings(defaultConfig.minai_context);
                
                markAsChanged();
                showStatus('Reset context builder settings to defaults', 'success');
            } catch (error) {
                console.error('Reset context builder settings error:', error);
                showStatus('Failed to reset context builder settings: ' + error.message, 'error');
            }
        }

        // Load preview on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshPreview();
        });
    </script>

</body>
</html>
