Changelog

MinAI server plugin version 2.1.3-dev7d
---------------------------------------

- Fix the configuration page - display items based on NSFW status
- Updates to increase compatibility with CHIM. Tested with CHIM v2.1.1 and CHIM v1.3.5.
- Few optimizations to increase increase fluency in rechat.

MinAI server plugin version 2.1.3-dev7c
---------------------------------------

- Compatible with CHIM v1.3.5.x / CHIM mod v1.3.5. In CHIM v2.x, Roleplay Modes and Preview section in Configuration Page will not be able to get information about NPCs. It will be fixed in the next version.
- Support for expressing emotions in speaking style. LLM is required to decide which emotion to express and at what intensity and to alter the way of speaking accordingly.
- Verbalized Sampling, a method to increase the diversity of responses generated by LLM at low temperature values. With this method, a LLM can generate responses with a high degree of diversity when used at the optimal temperature where it has maximum logical coherence. Implemented in conversation in this version, testing for diaries and memories follows.
- More context slop cleanup. Greatly reduced the events that are repeated and pollute the context history excessively in combat or loot. Duplicate entries have been eliminated. Similar records (found this, found that) have been limited to a maximum of 3-4 occurrences. Various unimportant mentions about deaths (rabbit, goat, chicken) have been eliminated. Also, from the lists of scanned entities around, various harmless dead or distant animals that generated conspiracy theories have been eliminated. The probability of having a history that contains mostly events to the detriment of dialogue is now extremely small.
- Added a new layer of prompt formatting and organization that results in increased coherence and attention. From testing, it's the most significant increase I've measured so far. Example: For locations with puzzles, I embedded the solution within the location description, as part of a large prompt of ~7000 tokens. I tested the setup by querying various LLMs to state the puzzle solution. Without any formatting, only about 20% of the answers were correct. With formatting applied, the accuracy improved to over 75% (some LLMs like Deepseek v3.2 had 100% accuracy).
- As a result of the new content formatting, the importance of context in generating dialogue has increased significantly. LLMs are now much more attentive to the thread of the conversation and focus better on the topics being discussed. 
- General improvement in LLMs' ability to perceive time and the temporal relationship between events.
- Non-consensual acts awareness and reactions. The NPC is aware that it is the victim of a non-consensual act and will react accordingly. The awareness part is algorithmic but once initiated, the outcome is decided by the LLM, in tests the reactions varied from complaint, acceptance, revolt or hatred and culminated in some cases with violent action against the aggressor (Attack or Brawl). Now implemented in the NPC-Player relationship, NPC-NPC could follow. 
- Improvement of Roleplay Chat Modes, rearranging prompt composition and structure to increase context awareness. The generated dialogues are more to the point, but also much more dependent on what's written in PLAYER_BIOS, which can be good news if what's there is well written bio or very bad news if the section contains other instructions unrelated to the player's bio.
- Improved dialogue in NSFW scenes, increased diversity and consistency. In scenes that have a correct description, the reactions are well correlated with the description and follow the action much better than the previous version. For scenes that do not have a description, LLMs are provided with a 'translation' of the somewhat cryptic tags of the scene and the reactions are much improved compared to previous versions, in most cases the NPCs interpret the scene correctly, generally without confusion if there are only two participants. In scenes without description with multiple NPCs involved, the LLM has no way of knowing the exact role of each participant and will try to guess from the context. In this situation a direct commentary or OoC that briefly describes the roles is useful and the following comments will be on point. Also, if you have Fertility Mode, LLMs may refer to information taken from this mod if it seems relevant in context.
- Special location details awareness. The location list has been expanded and reformatted. It includes brief information about the ruins with puzzles (mainly the solutions to the puzzles), locations where the player must pay attention to certain details, safe locations such as player homes where LLMs can now decide for themselves to relax in various ways.
- Player affiliations exposed in context (joinable factions like The Companions, Dark Brotherhood etc).
- Actions related to SLAPP and SLHH mods are now working, have been tested and are being activated. The condition is that all SLAPP and SLHH requirements are met; if something doesn't work, this is probably the first thing to check.
- Support for narration, enabled with REMOVE_ASTERISKS_FROM_OUTPUT = false in CHIM.
- Fixed some inconsistencies in interpreting NPC characteristics. The most important thing is gender, where inaccuracies could sometimes appear in the previous version, now the errors have been considerably reduced. 
- Fixes in equipment manager. 
- Fixes in in the prompt related to Devious Devices. 
- Updates for increased compatibility with CHIM.
- Other small fixes and changes that I can't remember exactly.

IMPORTANT!

1. If you are upgrading from a version prior to version 2.1.3-dev7 (like dev5 or older):
Immediately after the update, open the plugin Configuration Page, RESET the settings with [Reset All to Defaults] then save. 
Close the page, then reopen it and repeat the operation, reset to defaults and save.

2. The new changes to the context sent to the LLM alter the prompt interpretation priorities. Therefore, after updating and resetting the settings, leave all values ​​related to prompts and context at their default settings and launch the game. To calibrate new algorithms, it is necessary for LLMs to create new content for the context history:
- Temporarily disable Memory embedding.
- Temporarily disable Oghma Infinium.
- Speak with NPCs. You need more dialogue rounds than the length of CONTEXT_HISTORY. There is no point in temporarily shortening CONTEXT_HISTORY, you need to generate tens of lines in the dialogue history. If you have several AI-activated NPCs, you can let them talk to each other with Radiant Dialogue.


RELEASE NOTES
-------------

RECOMMENDED SETTINGS

Notes about some of MinAI and CHIM settings:

MCM
  MinAI - General
    LLM Response Request Cooldown - default 10s, keep the value in 8-16s interval
	Enable Sapience - disabled, see NOTE 1
	Enable Radiant Dialogue - preferably enabled and disable CHIM Smart Rechat and Serverside Bored Event, see NOTE 2
	Radiant Dialogue (NPC-NPC) Frequency - represents the interval in seconds at which each NPC's availability to speak is checked. Default is 30s, use a value in 30-60s interval.
    Roleplay Voice - with this key you can activate Translation Chat Mode or Roleplay Chat Mode using voice input. Translation (Player Input Lore Conversion): keep the key pressed, speak into the microphone, STT module will convert input and the resulting text is sent to a LLM to be adapted to the Skyrim lore. Roleplay (Player Automatic Response): tap (short press) the key, the LLM impersonates the player and generates a response. 
    Roleplay Text - with this key you can activate Translation Chat Mode or Roleplay Chat Mode using text input. Translation (Player Input Lore Conversion): player input text is sent to a LLM to be adapted to the Skyrim lore. Roleplay (Player Automatic Response): when leaving the text box empty, the LLM impersonates the player and generates a response. 
	Direct Prompting Text / Voice - assign a key to open input box, the text is injected in conversation as OoC instruction. The OoC instruction will be executed by the LLM if it fits at least partially into the context and situation, otherwise the LLM will ignore it.
  MinAI - Sex Settings
    Arousal Threshold for Sex - recommended 100. The lower the value, the more frequently sex scenes are triggered.
	Arousal Threshold for Flirting/Harassment - 100.
	Ask before a scene is initiated - enabled.
    Enable NPC - NPC sex - enabled	
	Comments rate - default 15s, recommended values between 10s and 20s. 
	Max Threads - represents the maximum number of scenes that can run simultaneously. Default 5, is a good value. If the value is too high the game will slow down with each new scene initiated and at some point it will crash.
  MinAI - Action Registry
	Here you can disable actions that you don't want NPCs to see and adjust the execution parameters. For example, 'interval' represents the cooldown period of the action. A lower value means that the action can be executed more often.

  
  CHIM - Main
    Voice Chat - assign a key to start voice chat (STT), Esc to reset key assignment
    Text Chat - assign a key to start text chat
    AI Agent Connection Timeout - the default value here, 30s, is a bit low and produces spam with messages regarding connection errors, it can be increased to 60s or more.
    Halt AI Actions - assign a key to stop actions if you loose control of activated NPCs
    Enable AI Actions - enabled 
	Toggle Modes - assign a key to toggle chat modes (Director Mode, Chat Assist etc). It is recommended to use a key that is not used for text input or in menus, such as a function key or a key from the numpad. 
	
  CHIM - Behavior 
    Auto Activate - better to activate intermittently, see NOTE 1.
    Dynamic Profile Timer - the default value of 20 min is low, recommended 60 min or more. A low value sometimes produces sudden, abnormal changes in NPCs personality.
	NPC Scene safety - enabled
	Allow combat dialogue - disabled
	Bored Event Timer - use a value in 40-80s interval.
	Smart Rechat - preferably disabled and enable MinAI Radiant Dialogue, see NOTE 2. 

  CHIM - Sound
    AI Voice Distance Scale - default 1.0 is to low, use a higher value (close to the max, 1000) 

  CHIM - AI Agents
    Remove All AI Agents - use this options to clean/trim your agents list periodically

Web UI

  CHIM - default or NPC profile
    RECHAT_H (Rechat Rounds) - 3 to 7 rounds
    RECHAT_P (Rechat Probability) - 60-75%
    BORED_EVENT (Bored Event Probability) - 60-75%
    BORED_EVENT_SERVERSIDE (Smart Bored Events) - False (disabled). Usually generates evil hallucinations when enabled. See NOTE 2.
    CONTEXT_HISTORY - 50 or a little more. If you want to save on the number of tokens in the prompt, a value of ~30 is acceptable. Very high values, over 100, given that the Prompt Slop Cleanup option in MinAI is enabled, are often unnecessary or can even dilute the effect of the prompt instructions.
    TIME_AWARENESS - False (disabled). The information in this plugin is incorrect in older versions, prior to 2.0. On the other hand, the same information is inserted into context by MinAI in a way that does not produce unwanted side effects as this plugin does.
	QUEST_COMMENT - False (disabled). NPCs are easily contaminated with goals obsession.
    CURRENT_TASK - False (disabled). NPCs are easily contaminated with tasks obsession.
	RPG_COMMENTS - always check 'keepmechecked'. 
	  Could check also 'combat_end' and 'lockpick', the comments generated are not very frequent and are not annoying. 
	  With 'bleedout', NPCs will become more agitated/alarmed than necessary if one is unconscious, it's not unnatural but it can become stressful for the player. 
	  'levelup', 'learn_shout', 'learn_word', 'absorb_soul' will generate repetitive comments, in my opinion.
	DETECT_MAGIC_EVENT - preferably disabled, can be enabled without spamming only if Prompt Slop Cleanup option in MinAI is enabled. 
	EMOTEMOODS - It would be preferable for the list to be completed as follows: 
	  'default,neutral,assisting,assertive,playful,sexy,amused,kindly,lovely,seductive, smug,sassy,sarcastic,sardonic,smirking,irritated,teasing,mocking,angry,anxious,sad,drunk,high,sober'. 
	  Trying to remove negative attitudes from the list is not recommended. To express the full range of emotions, all moods are required because emotions correlate with a certain state of mind. If an LLM is hostile or mocking, the problem is not here but in the prompt.
	REMOVE_ASTERISKS_FROM_OUTPUT - True (enabled).
	
	
NOTE 1: Auto activation. The first and most important rule is do not enable both CHIM Auto Activate and MinAI Sapience options. 
Of the two, it is preferable to use CHIM Auto Activate. It is preferable not to keep auto activation enabled all the time because in a short time you will no longer be able to manage the generated profiles, activate the option only when necessary and clean the list of activated NPCs periodically. The list of profiles is managed from the CHIM Web UI and mass deleting profiles is not easy. The list of activated NPCs that is visible in MCM CHIM - AI Agents is saved in skse cosave, a file that will frequently get corrupted.

NOTE 2: NPCs engage in conversations as a result of:
- Radiant Dialogue events (MinAI)
- Bored events generated with Bored Event Probability (CHIM)
- Bored events generated by Bored Event Serverside (CHIM)
- Rechat events with Rechat Rounds/Rechat Probability that follow a Bored event
- Rechat events generated by Smart Rechat, narration etc. (CHIM)

MinAI suspends CHIM bored and rechat events during Radiant Dialogue and during sex scenes to preserve the fluency of the conversation. 
CHIM Bored Event Serverside and Smart Rechat are events that occur asynchronously and can overlap with conversations initiated in MinAI. 
Normally, overlaps do not cause problems, but in certain situations the following can happen: 
- NPCs are following different conversations in parallel. 
- Overlapping conversations causes lines of dialogue to be generated at a rate much faster than TTS can process, so some lines will not be displayed on the screen or spoken until TTS catches up with the dialogue. 

Possible settings:
- Enable Radiant Dialogue and disable Bored Events Serverside and Smart Rechat (recommended).
- Conversely, disable Radiant Dialogue and enable Bored Events Serverside and Smart Rechat (I feel like the conversation isn't as fluid with this option, and all LLMs have an appetite for dark obsessions and hallucinations to support them).
- Leave them all enabled (Carpe Diem) but significantly increase the values ​​in Radiant Dialogue Frequency, Bored Event Timer and decrease the values ​​in RECHAT_H, RECHAT_P, BORED_EVENT.

Director Mode is also an asynchronous event that can overlap with Radiant Dialogue or sex scenes. In this case, the script generation will be delayed and the script will also take into account lines of dialogue after the command was initiated. The delay in triggering the DM can make users think that the event has failed, which is not the case. 

MINAI MOD INSTALLATION

MinAI mod (MinAI.esp) can be activated almost anytime in an existing game, with some restrictions:
- CHIM AiAgent is activated. 
- Is loaded after AiAgent. 
- Should be activated only in a cell without NPCs.
MinAI mod and CHIM mod (AIAgent.esp) could be activated at the start of a new game only after going through the introduction and the player has a name (after Racemenu). 
A fast and safe way to start a game is with Alternate Start - Live Another Life mod which provides a starting location without other NPCs where MinAI can be activated without problems. 

ABOUT PROMPT STRUCTURE

The sections that make up the prompt sent to the LLM have a different influence on the generated response. In order of importance:
0. Action prompts from MinAI and TEMPLATE_DIALOG (internal instructions).
1. Dialogue history and recent events (CHIM - context history).
2. Character personality (CHIM - HERIKA_PERS and the other HERIKA_??? associated fields).
3. Environment and primary objectives (PROMPT_HEAD).
4. Other

Your prompt modification strategy should take this into account for maximum efficiency. For example, if you don't like the way a character speaks, the place to make changes is HERIKA_SPEECHSTYLE, not PROMPT_HEAD. If you make the change in PROMPT_HEAD, besides the fact that all NPCs will speak the same, it is not so efficient.

If you want to make changes to the prompt:
- You will notice an increased latency between your prompt changes and the effect on the text generated by the LLM. The first impression is that the LLM ignores your changes. It's not like that, LLMs pay now more attention to context than before and the effects of new instructions are felt gradually, as they affect more lines in the dialogue history.
- Heavily censored models such as those from Anthropic or OpenAI could activate soft or hard guardrails. This is because there are several sections in the prompt that directly contradict instructions from their internal system prompt and being formulated with similar 'strength' could pass as jailbreak attempts.
- By default, prompt-related settings replace PROMPT_HEAD, TEMPLATE_DIALOG and other instructions from CHIM with MinAI versions, PLAYER_BIOS and HERIKA_BIOS and related fields are taken from CHIM. These changes (mostly configurable/editable) are made to ​​implement the new algorithms (emotions, verbalized sampling, efficient formatting) in uniform manner and being neutral/unbiased with as many general-purpose LLMs as possible. 

The default prompt structure in this version has been tested with the following LLMs: ZAI GLM 4.x, Deepseek v3.x, Kimi K2, QWEN 3, Gemini 2.x flash, Grok, Meta Llama 4, MistralAI, Meituan LongCat Flash Chat, Inclusionai Ling 1T and briefly with a few others. 

SPEECH PATTERNS 

It is very easy for an NPC to develop speech patterns if the LLM receives generic instructions to speak like a human being, is not given clear speech examples or the examples contain filler words or phrases. The result is that once a pattern appears, other NPCs can be contaminated by dialogue history. An attempted correction made in PROMPT_HEAD is often ineffective, maybe even ignored if it is formulated as a negation - "don't do". LLMs are trained to respond to positive "do" type instructions, "don't do" without context generates confusion. A negative instruction should be presented in antithesis or as a restriction/exception/constraint like this: "Do this, avoid/don't do/except/but not that". In conclusion, corrections for speech patterns should be included at the end of the prompt in Action Prompts, after all the "do this" in the rest of the prompt.

TROUBLESHOOTING

Some problems that are difficult to troubleshoot:
1. NPCs are quiet, no rechat or bored events. Sometimes, save take a significantly longer time to complete. 
One of the causes is suspended execution of some scripts. Save, exit the game and load the save in ReSaver. 
Check Suspended Stacks 1 and 2, if there are many scripts, you could try to delete them. Better solution: find an older save with clean Suspended Stacks.
2. When loading a save, the list of activated NPCs in MCM CHIM is different from what it was before. 
Either some NPCs are no longer activated, or NPCs that were deactivated still appear in the list. The list in MCM CHIM is out of sync with the list in CHIM Web UI. Occurs when the SKSE cosave is corrupted. You can try to find a recent save without problems, or if not, as a last resort, delete the file with the .skse extension from the most recent save and leave only the .ess. A new save will produce a clean skse cosave, the disadvantage is that some MCM modules that keep settings in the .skse file will revert to default values. A good idea is to periodically trim the skse cosave with a tool like NetImmerse Override Cleaner.


INSTALL OR PATCH WITH FILES FROM WINDOWS

After one or more files from WSL Dwemer web server have been copied or edited in Windows, file attributes must be restored.

Open CHIM.exe -> Debugging -> Open Terminal 
and paste this commands with 'right click' (password is 'dwemer' when asked):

sudo chmod -R -v u=rwx,g=rwx,o=rwx /var/www/html/HerikaServer
 
sudo chown -hR dwemer:www-data /var/www/html/HerikaServer

Also you could delete the file 
\\wsl.localhost\DwemerAI4Skyrim3\var\www\html\HerikaServer\ext\minai_plugin\config.php
then enter the configuration page, reset to defaults and save.

About WSL and permissions:
- The Apache server runs with the credentials user=dwemer group=www-data
- Access from windows to files hosted by WSL is done with user=root credentials
Therefore, every time WSL files are modified from Windows, the file attributes related to ownership and access/execute rights must be restored. 
The commands that restore the attributes apply to the folder where the changes were made or one level higher and are given from the Linux command line.


